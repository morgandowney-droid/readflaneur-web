# Flaneur Web

> **User Location:** Stockholm, Sweden (CET/CEST timezone)
> **Full changelog:** `docs/CHANGELOG.md` (read only when needed)
> **Mobile app:** `../flaneur/CLAUDE.md`

## What's Live

- **Website:** https://readflaneur.com
- **Backend API:** https://flaneur-azure.vercel.app
- **GitHub:** https://github.com/morgandowney-droid/readflaneur-web
- **Sentry:** https://sentry.io/organizations/flaneur-vk/issues/
- **270 neighborhoods** across 91 cities, 42 countries

## Last Updated: 2026-03-01

Recent work: Three mobile UX improvements (mobile feed "Make {name} my primary" link below dropdown when non-primary pill selected with sync-primary API call, neighborhood selector modal inline action row replacing instant deselect when tapping selected neighborhoods with Set Primary/Go to stories/Remove options and expandedId state reset on search/tab change, mobile keyboard search fix hiding selected pills and sort buttons when isSearchActive && searchQuery to maximize result space with 200ms blur delay for click registration, modal makePrimary fixed to call sync-primary API for DB sync, 3 new translation keys feed.makePrimary/feed.goToStories/general.remove in all 9 languages), Fix Sunday Edition per-recipient dedup (neighborhood fallback loop combined with per-neighborhood dedup meant hourly cron runs could send multiple Sunday Editions to the same person via different neighborhoods - changed to per-recipient dedup so each person gets at most one Sunday Edition per week, `recipientsSentThisWeek` Set checks `recipient_id` not `recipient_id:neighborhood_id`), Fix instant resend Sunday skip (instant resend triggered by primary neighborhood changes had no Sunday check while daily brief cron skips Sundays - added `getUTCDay() === 0` early return), Sunday Edition email fixes (ad resolver date range `.lte`/`.gte` instead of `.eq` so multi-day ads resolve correctly, render all narrative paragraphs in The Letter instead of just teaser, remove duplicate "Continue reading" link keeping single "Read the full edition" CTA, show postcards AND "Your Other Editions" together instead of either/or, fall back to other subscribed neighborhoods when primary has no weekly brief, add Unsplash hero image via selectLibraryImageAsync, ban "quiet significance" generic opener in Sunday Edition prompts, protect markdown links from sentence splitting in ArticleBody), Community neighborhood 1-week reminder email (daily cron at 9 AM UTC sends branded email to creators 7 days after creation with link to most recent daily brief article, 24h time-window dedup needs no migration, logged to cron_executions), Database-level brief dedup constraint (UNIQUE(neighborhood_id, brief_date) on neighborhood_briefs prevents duplicate briefs at DB level regardless of application bugs, three-layer defense with pre-Grok real-time check and batch filter, brief_date DATE NOT NULL column backfilled from generated_at+timezone, all 3 INSERT sites handle 23505 unique_violation, simplified dedup in generate-brief-articles and health-checks), Community neighborhood celebration experience (on creation, modal closes and navigates to /{city}/{neighborhood}?created=true, NewNeighborhoodCelebration component shows elapsed-seconds countdown with pulsing dot and "Building your {name} edition" message while polling Supabase every 3s for first published article, balloon emoji celebration animation rises from bottom when content arrives then auto-strips ?created param and refreshes feed, safety timeout at 90s, prominent create CTA in modal search empty state with amber-bordered card and full-width "Create {query}" button hiding sort buttons and selected pills, "Created by you" accent-colored badge in selector for creator's own community neighborhoods vs grey "Community" for others), Instant translation for community neighborhood creation (when creator has a non-English preferred_language, pipeline translates brief+article via Gemini Flash in parallel after article creation so user sees content in their language immediately instead of waiting up to 60min for translate-content cron), Claude fallback enricher for community neighborhoods (when Gemini enrichment fails during creation due to quota exhaustion or API errors, enrichWithClaude() produces same polished output format with local-language greetings, section headers, prose paragraphs, and subject teaser - users never see raw bullet-point facts), Faster community neighborhood creation (Gemini Flash Search ~10s instead of Grok ~40s, image library in parallel, newsletter_subscribers sync so crons pick up new neighborhoods), Persist theme/language preferences to DB for cross-device sync (preferred_theme and preferred_language columns on profiles table, /api/preferences POST endpoint saves changes fire-and-forget, signin API returns prefs in profile data, login page restores to localStorage, PreferencesSync component in layout handles OAuth login restoration from flaneur-profile cache, one-time per session), Feed empty state shows "Already have an account? Sign in" link (users arriving from email story links without cookies see login path instead of dead-end "Choose Neighborhoods"), Accept towns and small cities in community neighborhood creation (Gemini validation prompt expanded from "neighborhood or district within a city" to also accept standalone towns, villages, municipalities and cities like Utrera Spain, only rejects countries/states/continents/fictional places), Fix community tab auth gate for signed-in users (getSession 3s timeout caused userId to be null showing "Sign In" even for authenticated users - added flaneur-auth localStorage fallback matching Header pattern for instant auth detection), Unify article body font and reduce text size (removed 3 sans-serif font overrides from EventListingBlock so all article content uses Merriweather serif consistently, reduced desktop body text from text-[1.35rem]/22px to text-[1.2rem]/19px, mobile from text-[1.2rem] to text-[1.1rem], leading-loose to leading-relaxed, paragraph spacing mb-8 to mb-6, section headers text-xl to text-lg with proportional spacing), Enable Google OAuth login (unhide Google button on login and signup pages with "Continue with Google" label and "or" divider above email/password form, uses existing signInWithOAuth plumbing through /api/auth/callback, Apple login remains hidden), Fix My Neighborhoods masthead flash (NeighborhoodHeader now only renders when a specific pill is active via conditional rendering instead of CSS hidden class - prevents large serif heading from flashing during cookie sync or stale router cache when neighborhoods array is temporarily empty and isMultiple is false), Mobile wake-up screen polish (inline city name to right of neighborhood name in NeighborhoodHeader when pill selected saves vertical space via flex items-baseline, mobile-only primary neighborhood indicator md:hidden between masthead and Daily Brief shows serif name + grey city on left with NeighborhoodLiveStatus weather/time on right so users see which neighborhood the brief is for on the All Stories wake-up screen, Daily Brief top margin tightened to mt-0 on mobile), Hide redundant mobile feed elements (My Neighborhoods masthead hidden on ALL screens when !activeFilter && isMultiple not just desktop, mobile gallery view toggle section removed entirely), Feed UX improvements and bug fixes (clickable "PRIMARY NEIGHBORHOOD {name}" in compact masthead navigates to neighborhood feed page via Link component, selected neighborhoods shown as removable pills at top of selector modal for quick management with primary amber dot indicator and x-to-remove, bento section header says "Your Neighborhoods Today" in all 9 languages, fix bento grid flash on back-navigation by caching userBentoCards in sessionStorage flaneur-user-bento-v1 for instant restore when navigating back to /feed, fix Look Ahead articles showing individual source names by treating editorial articles as having no individual sources in SourceAttribution - isEditorial condition added to empty-sources branch so editorial content always shows generic "Synthesized from public news sources" attribution), Paginated bento grid with jump-to-feed arrow (desktop bento grid keeps original 4-column CSS grid with hero/wide/standard card sizes but adds paginated navigation - PaginatedSection component manages per-section page state with PAGE_SIZE=3, section headers show left/right arrows + "1/N" page indicator when totalPages > 1, "My Neighborhoods" shows ALL user neighborhoods via client-side REST fetch not capped at 3, regional discovery sections show up to 8 cards each not 3, JumpToFeedArrow below user section with bounce animation smooth-scrolls to ALL STORIES divider, user section merged at render time via useMemo to avoid race condition with async fetch, sessionStorage cache versioned to v2 to invalidate stale data, cached user sections filtered by translationKey to prevent duplicates, compact desktop masthead shows "PRIMARY NEIGHBORHOOD" label with baseline-aligned name+weather always visible without flash via isMultiple condition not bento-data-dependent, full NeighborhoodHeader hidden on desktop via md:hidden when bento active, API cap raised from 5 to 12, hook fetches count=8, mobile layout untouched), Fix mobile feed empty state flash during cookie sync (logged-in users saw "Select neighborhoods" CTA for 1-2 seconds before real feed appeared because server rendered with empty cookie then client hydrated and called router.refresh - added syncChecked gate in MultiFeed that suppresses empty state until localStorage has been checked confirming no neighborhoods exist), Fix timezone bugs in Look Ahead dedup and Sunday Edition and brief articles (Look Ahead dedup for UTC+11..+13 neighborhoods like Waiheke queried wrong UTC date range because publishAtUtc fell on previous UTC calendar day - fixed with broad time window + per-neighborhood publishAtUtc comparison within 2h tolerance; Sunday Edition sync-weekly-brief used today's UTC date as weekDate so Saturday and Sunday runs created separate editions causing duplicates - fixed to always calculate "this coming Sunday" date; brief article dedup used UTC date from generated_at instead of per-neighborhood local date - fixed with IANA timezone-aware local date; getDayAbbr on article pages now uses neighborhood timezone so "Fri Daily Brief" won't show on Saturday; slug date also uses local timezone), Move postcard section back to bottom of daily brief email as a reward for reading to the end (was between primary stories and satellites, now after Family Corner just before Footer), Fix email date labels using recipient timezone (formatDateline/isSameDay/cleanCategoryLabel in assembler.ts now accept recipient IANA timezone so date labels like "Daily Brief (Today) - Sat Feb 28" display correctly instead of server UTC which caused NYC briefs to show "Fri Feb 27" in Stockholm morning emails, recipient.timezone threaded from assembleDailyBrief through fetchBriefAsStory/fetchLookAheadAsStory/toEmailStory to all date formatting functions for both primary and satellite sections), Polish exploration UX (in explore mode ExplorationNextSuggestions now renders ABOVE BriefDiscoveryFooter so "Keep Exploring" is the primary CTA right after subscribe nudge instead of buried below "Keep Reading" current-neighborhood links, hero card CTA bumped from text-xs text-white/70 to text-sm text-white font-medium for readability on dark images, secondary suggestion links now show 32px circular Unsplash thumbnails matching sticky bar style with flex layout, border-t divider above "Keep exploring" section for visual separation), Hide ads and redundant CTAs during explore sessions (top and bottom house ads, PostReadEmailCapture, and MoreStoriesButton all hidden when ?explore=true - explorer sees back link then article content immediately instead of house ad blocking the view, bottom of page flows from subscribe nudge through discovery links to hero card to footer with no interruptions), Deepen exploration engagement beyond 1 level (Visual "Read Next" card with Unsplash photo replaces plain text links in ExplorationNextSuggestions - hero card with aspect-[2/1] md:aspect-[5/2] gradient overlay showing neighborhood/city/headline and "Continue exploring" CTA with secondary text links below truncated on mobile, sessionStorage cache prevents redundant API calls, exclude param passes visited neighborhood IDs to break suggestion ping-pong loops; Sticky ExplorationBar bottom bar appears at 40% scroll via IntersectionObserver during ?explore=true sessions with glassmorphism bg-surface/90 backdrop-blur-md showing circular thumbnail and neighborhood name and "Next" link, bottom-0 md:bottom-14 with z-[55] to sit above location toast on mobile, pointer-events-none on outer wrapper with pointer-events-auto on content div only so clicks pass through to elements below like location toast buttons, 500ms delay before cache check so ExplorationNextSuggestions caches first, own getVisitedIds() + exclude param prevents wrong suggestion on level 2+ pages, hides on scroll-up reappears on scroll-down, dismiss to sessionStorage; Exploration session trail via useExplorationSession hook tracking visited neighborhoods in flaneur-exploration-session sessionStorage with trail count in BackToFeedLink showing "Exploring (N neighborhoods)" when trail > 1; ExploreSubscribeNudge inline one-tap "Enjoying {name}? Add to my neighborhoods" subscribe nudge after SourceAttribution on explore articles with localStorage add and cookie sync and fire-and-forget API call; /api/explore/next returns imageUrl field filtering to Unsplash-only URLs with exclude param for visited neighborhoods; ExplorationWrapper client wrappers connect session state to server-rendered article page), Polish email template (remove "Share on X / Facebook" links from lead story since nobody shares from inside an email), Polish exploration discovery UX (toggle "+" button on discovery cards with add/remove and "Added to feed"/"Removed" feedback label with localStorage check on mount for pre-existing subscriptions, move ExplorationNextSuggestions above bottom ad on article pages for better visibility, remove redundant "Explore nearby" neighborhood pills section and its DB query), Exploration discovery redesign (Part 1 Email Postcards - email_postcards cache table with scoring algorithm for daily/sunday postcard selection prioritizing proper nouns and city diversity with 7-day recency check, PostcardSection React Email component with gold POSTCARD label and warm background for daily single and sunday triple variants, wired into assembler/DailyBriefTemplate after Family Corner and SundayEditionTemplate replacing "Your Other Editions"; Part 2 Mobile Feed Discovery - useDiscoveryBriefs hook extracted from MultiFeed replacing ~180 lines of inline bento state, MobileDiscoveryCard photo cards in 2-col grid with aspect-4/3 and subscribe button, MobileDiscoverySection container with "Beyond {Name}" title and region labels and "Show me more" refresh, NeighborhoodDiscovery client wrapper for single-neighborhood pages, MultiFeed refactored to use hook with mobile section added, NeighborhoodFeed discovery prop wired into neighborhood and feed pages; Part 3 Article Page Exploration - /api/explore/next endpoint with three strategies sameCity/sameTheme/geoHop using Haversine distance for geographic hops, ExplorationNextSuggestions component showing up to 3 contextual links "Also in {city}"/"Elsewhere"/"Meanwhile in {city}", ?explore=true URL param for exploration session tracking with BackToFeedLink showing "Keep Exploring" vs "All My Neighborhood Stories"; Part 4 Removals - AddToCollectionCTA removed from FallbackAd ~70 lines, escape_mode house ad deactivated and references removed from FallbackAd and email/ads.ts, BriefDiscoveryFooter simplified from 248 to 92 lines keeping only yesterday brief and Look Ahead links, NeighborhoodBrief discovery CTAs removed including nearbyDiscovery/randomDiscovery/yesterdayUrl state and lazy-fetch useEffect, BentoCard links now append ?explore=true, translation keys bento.beyond/bento.beyondYour/bento.showMore/explore.keepExploring added in all 9 languages), Expand Look Ahead search to include major cultural venues (Grok and Gemini Search prompts were neighborhood-scoped so city-wide venues like national theaters, opera houses, concert halls, and philharmonics were missed - added explicit MAJOR CULTURAL VENUES search instructions to both grok.ts generateLookAhead and gemini-search.ts searchUpcomingEvents with note that these venues serve all neighborhoods not just the one they're in), Polish Look Ahead event listing (strip "(not Vasastan)" neighborhood annotations from addresses via stripNeighborhoodAnnotations regex, normalize category badges by stripping "/SubType" suffixes like "Music/Show" to "Music", make filter bar collapsible behind "Filter" toggle button with count badge to save vertical space on mobile), Redesign Look Ahead event listing with interactive filters and hyperlinks (EventListingBlock replaced with parsed structured events featuring Google Search hyperlinked names with dotted-underline academic styling, three filter dimensions as horizontal pill rows - day pills/time-of-day chips morning|afternoon|evening|all-day/category chips with +N more toggle, two-line event layout with name+category badge then time/venue/address/price with middot separators, isPlaceholder() filters "Not Listed"/"TBD"/"TBA"/"N/A" at both source and render, locale-aware AM/PM via formatTime() for US/USA country, prose body skipped entirely when articleType=look_ahead and event listing exists since it restates same events, country prop threaded through ArticleBody->TranslatedArticleBody->slug page), Fix Supabase 1000-row default limit causing duplicate brief generation (sync-neighborhood-briefs recentBriefs query had no .limit() so with ~1890+ briefs in 7-day window Supabase silently dropped rows causing hasBriefForLocalToday to return false for already-generated neighborhoods - 4 alphabetically-first NYC neighborhoods regenerated every run 10+ times while Tribeca/West Village/Upper West Side etc stayed pending - added .limit(5000) to sync cron and .limit(3000) to health-checks and issue-detector monitoring queries), Fix email assembler brief shadowing bug (fetchBriefAsStory fallback query fetched newest brief by created_at without filtering enriched_content in the query causing a newer unenriched brief to shadow an older enriched one and return null - moved enriched_content IS NOT NULL into DB query, aligned subject teaser query to use same sort order created_at DESC and same filters as body query so subject line and body always reference the same brief), Prioritize city-qualified Unsplash results with 3:1 ratio (ambiguous neighborhood names like SoHo Chelsea Downtown got wrong city's photos because interleave function used 1:1 alternating between city-qualified and name-only results - changed to 3:1 ratio taking 3 city-qualified for every 1 name-only so 6+ of 8 category slots get correct city's photos), Polish bento grid with 5 fixes (lighter gradient overlay from-black/70 via-black/25 with text-shadow safety net for bright photos, lopsided discovery sections now use two wide cards when region has exactly 2 briefs and skip sections with <2 cards, "+" subscribe button on discovery cards adds neighborhood to collection without navigating away via onAdd prop with optimistic checkmark UI, sessionStorage cache prevents bento content from reshuffling within a session with "Discover more" refresh button to get fresh neighborhoods, compact masthead between pills and bento shows "My Neighborhoods" clickable + location count + primary neighborhood name and weather/time via NeighborhoodLiveStatus), Fix Daily Brief card showing teaser text before greeting (Gemini sometimes outputs subject_teaser and email_teaser values as standalone prose paragraphs before the "Morning, neighbors." greeting without label prefixes, bypassing existing SUBJECT TEASER:/EMAIL TEASER: regex stripping - NeighborhoodBrief.tsx now finds first greeting/filler paragraph and drops everything before it, matching ArticleBody.tsx pre-greeting stripping logic, inconsistency was per-brief since Gemini outputs labels for some neighborhoods but not others), Expand image rotation to full Unsplash photo pool (RSS/news articles now draw from 8 category photos + up to 40 alternates stored in `unsplash_alternates` JSONB giving ~48 unique images per neighborhood, `CacheEntry` includes `alternates` field loaded by `preloadUnsplashCache`/`getUnsplashPhotos`/`selectLibraryImageAsync`, `selectLibraryImage` builds combined pool for rotatable articles, refresh cron triggers regeneration for neighborhoods with empty alternates to backfill the overflow pool), Rotate RSS/news article images across full photo library (RSS and news articles all used the single `rss-story` category photo causing identical images on every article for a neighborhood - now rotates across all 8 Unsplash library categories using `articleIndex` param so consecutive articles get different photos, added `articleIndex` to `selectLibraryImage`/`selectLibraryImageAsync` signatures, updated sync-news, sync-nuisance-watch, retry-missing-images), Use Gemini subject_teaser for Look Ahead headlines (Look Ahead articles used Grok's raw HEADLINE output producing generic date-heavy headlines like "Art Openings Thu" and "Wine Class Tonight!" while Daily Brief got punchy Gemini teasers - now prefers `enriched.subjectTeaser` via `toHeadlineCase()` matching Daily Brief pattern, Grok headline as fallback), Fix repeating topics in daily briefs (three-layer anti-repetition - Grok now receives last 10 headlines via `recentTopics` param with instruction to find different stories unless genuinely new info exists, Gemini enrichment changed from passive "you may reference" to active "DROP repeated stories entirely", continuity context window extended from 5d/3d to 10d/7d lookback with 10/20 item limits, sync-neighborhood-briefs lookback extended from 36h to 7 days with 10 headlines instead of 5, fixes persistent topics like restaurant closures appearing in every brief for 2 weeks), Auto-swap negatively-scored Unsplash photos (image_feedback thumbs-down votes now trigger automatic replacement - `searchAllCategoriesWithAlternates()` saves ~40 overflow photos per neighborhood in `unsplash_alternates` JSONB, `swapNegativeImage()` replaces bad photo in library + bulk-updates all articles using it + blacklists old photo ID in `rejected_image_ids` so it never returns on refresh, Phase 3 added to `retry-missing-images` cron calling `get_negative_images` RPC for score <= -2 threshold, zero extra Unsplash API calls since alternates are overflow from existing dual-search), Family Corner email improvements (light divider between age groups, neighborhood name in "For your primary neighborhood: Tribeca", shorter intriguing headlines max 50 chars naming specific activity not generic, skip empty day sub-sections instead of "No specific events today" filler), Fix Daily Brief article greeting consistency (Gemini outputs subject_teaser/email_teaser as prose before greeting causing some briefs to open with teaser text instead of "Morning, neighbors." - ArticleBody.tsx now strips pre-greeting paragraphs for brief_summary articles, greeting patterns cover 9 languages, articleType prop threaded through TranslatedArticleBody), Rounded corners on website images/ads/buttons (rounded-xl on feed card thumbnails, gallery hero images, article detail hero, ad card images, all ad/house ad containers; rounded-lg on inline CTA buttons and form inputs), Softer rounded corners on email images and buttons (Hedvig-inspired - hero/outer images 4px to 12px, ad/sponsor containers 4px to 12px, nested images 4px to 8px, CTA buttons 4px to 8px, weather box 6px to 12px, added missing borderRadius to Sunday Edition hero image; 5 files: HeroStory, Header, NativeAd, SundayEditionTemplate, DailyBriefTemplate), Fix Look Ahead published_at 24h off for APAC timezones (getLocalPublishDate() used noon UTC as reference to calculate timezone offset but noon UTC crosses the date boundary for UTC+9 to +13 zones - Waiheke NZ got published_at of 7AM Feb 26 instead of Feb 25; fixed by using midnight UTC and comparing local day/month to detect date boundary crossing; also fixed formatRelativeTime() showing "-461m ago" for future published_at by returning just the date string), Use subject_teaser as Daily Brief article headline (the short 1-4 word Gemini-generated teaser like "heated school meeting" or "$12m lodge sale" now used as article headline in Title Case via new `toHeadlineCase()` in utils.ts, replacing the longer Grok-generated headline; falls back to Grok headline when null; both `generate-brief-articles` cron and assembler.ts fallback path updated; email subject path completely independent - reads `subject_teaser` from `neighborhood_briefs` table directly, no circular dependency), Filter routine gallery hours from Look Ahead articles (Grok was listing 13+ galleries simply open during normal hours as "events" padding Look Ahead articles - three-layer fix across Grok prompt, Gemini enrichment lookAheadStyle, and Gemini Search searchUpcomingEvents: new GALLERY/MUSEUM FILTER requires specific time-limited occasions like opening receptions, closing days, artist talks, exhibition premieres - "Gallery X shows Artist Y" is not an event; headline rule now requires referencing today or the very next day with events, never headlining something 2+ days away; exclusion list expanded to cover venues open during normal hours with ongoing exhibitions), Align email assembler blurb filters with feed-side fixes (assembler.ts `isGreetingStart()` expanded to check first sentence with curly apostrophe support and filler openers like "Here's the download"/"Another brisk morning"/"A crisp Tuesday"; `isFillerText()` expanded with generic scene-setters and `['\u2019]?` patterns; new `isSignOff()` detects closing remarks like "Enjoy the day"/"Stay warm"/"Until tomorrow"; `extractInformativeSentences()` now strips teaser labels case-insensitively and filters sign-offs; `needsBetterPreview` checks sign-offs), Fix case-insensitive teaser label stripping and generic filler openers (Gemini outputs teaser labels in varying case "SUBJECT TEASER:"/"subject_teaser:"/"EMAIL TEASER:"/"email_teaser:" - updated regex to case-insensitive in NeighborhoodBrief.tsx, ArticleBody.tsx, brief-enricher-gemini.ts; added generic scene-setting filler patterns "Another brisk/chilly/warm morning"/"A crisp Tuesday"/"Right then, Tuesday"/"Here is the latest" to both NeighborhoodBrief.tsx and CompactArticleCard.tsx), Fix [[header]] marker stripping and sign-off detection in brief preview (paragraph loop now strips `[[header]]` markers instead of skipping entire paragraph so "[[Tin Building Goes Dark]] The corporation's..." shows content after marker; added `isSignOff()` for closing remarks like "Enjoy the day"; paragraphs under 30 chars skipped; fallback when all paragraphs are filler changed from `paragraphs[0]` to empty string with secondary search), Handle curly apostrophes in filler detection (Gemini outputs U+2019 right single quotation mark instead of ASCII apostrophe - filler patterns like "Here\u2019s the download" used `'?` which only matched ASCII 0x27, updated all regex patterns in both NeighborhoodBrief.tsx and CompactArticleCard.tsx to use `['\u2019]?` character class), Fix multi-paragraph filler skip in Daily Brief card (enriched briefs have separate short paragraphs for each filler line - P0: "Morning, neighbors." P1: "Here\u2019s the download..." P2: "[[header]]" - old code only skipped P0 and used P1 unconditionally, now loops through all paragraphs skipping filler and `[[header]]` section markers, extracts useful sentences from long filler-starting paragraphs; also fixed 200-char length limit on `isGreetingOrFillerParagraph` to check first sentence only with no length limit, added "If you're just waking up" filler pattern), Skip filler blurbs in feed cards and suppress subscribe prompt for logged-in users (NeighborhoodBrief expanded `isGreetingParagraph` to `isGreetingOrFillerParagraph` detecting filler openers like "Here's the download", "It's been a busy week", date-only sentences across 9 languages; CompactArticleCard added `cleanBlurb()` that skips filler/greeting sentences before truncating so feed blurbs show real content; ReturnVisitPrompt and EmailCaptureCard now suppress subscribe prompts when `flaneur-auth` localStorage exists since logged-in users are auto-subscribed), Fix Look Ahead article paragraph splitting (sentence-boundary splitting only triggered when there was exactly 1 paragraph over 500 chars - Look Ahead articles have one paragraph per day section under [[Day, Date]] headers so the condition never fired, resulting in wall-of-text day sections with multiple events crammed together; now applies splitting to any paragraph over 400 chars at ~300 char sentence boundaries, giving each event/topic its own paragraph), Replace Look Ahead expandable card with simple link (the expandable card with "At a glance" event listing was visually jarring and didn't integrate with the brief styling - replaced LookAheadCard with a minimal component that fetches the Look Ahead URL and renders a clean link "What's Coming Up in {name}" below the Daily Brief, removed 324 lines of event listing/prose rendering/discovery CTA code, same props interface so 3 callsites unchanged), Strip SUBJECT TEASER/EMAIL TEASER labels and Daily Brief label from display (Gemini outputs "SUBJECT TEASER: snowball showdown" and "EMAIL TEASER: Snowball fight targets..." as visible prose alongside JSON block - stripped in brief-enricher-gemini.ts to prevent storage, plus render-time stripping in NeighborhoodBrief.tsx cleanContent(), ArticleBody.tsx, and LookAheadCard.tsx for existing articles; also strips "Daily Brief: {name}." label text from Look Ahead teaser and expanded body), Post-process email teasers for Gemini stubborn patterns (Gemini Pro ignores negative prompt instructions like "NEVER say starts tomorrow" - two fixes: JSON schema example now shows concrete teaser text instead of description placeholder since Gemini follows examples over prose, new `cleanEmailTeaser()` post-processor strips connective filler words like "Plus,"/"Also,"/"Meanwhile,", converts passive future to active present like "starts tomorrow" to "now live" and "opens tomorrow" to "just opened", removes boilerplate openers like "See what's on at"/"Check out"/"Don't miss"), Information-dense email teasers and Look Ahead blurb fix (added `email_teaser` field to Gemini enrichment JSON response - generates 2-3 sentence teasers packed with specific names/places/facts at zero extra API cost, stored in `neighborhood_briefs.email_teaser`, used as `preview_text` when creating brief_summary and look_ahead articles in generate-brief-articles and generate-look-ahead crons and assembler fallback path; fixed Look Ahead articles showing "Daily Brief: {neighborhood}." as blurb by stripping label text in `generatePreviewText()`; replaced broken `isGreetingOnly()` in assembler.ts - had 60-char length limit that let greetings like "Morning, neighbors. It's been a busy couple of weeks for openings." bypass detection - with three robust helpers: `isGreetingStart()` checks first sentence only with no length limit, `isLabelText()` detects "Daily Brief:"/"Look Ahead:" prefix labels, `isFillerText()` detects vague openers like "It's been a busy couple of weeks"; new `extractInformativeSentences()` filters out greetings/labels/filler/date-only sentences and builds 160-char information-dense blurbs from body text; `enrich-briefs` cron saves `email_teaser` to DB alongside `subject_teaser`; subject teasers all lowercase with no leading "the"; email teaser prompt enforces standalone nuggets with active present tense and no filler words), Fix broken legacy image URLs in assembler fallback (added selectLibraryImageAsync for async DB lookup without cache preload, removed legacy Supabase Storage URL fallback from selectLibraryImage sync path since all 273 neighborhoods have Unsplash photos, backfilled 15 broken articles), Dual-source fact-gathering with Gemini Search alongside Grok (new `src/lib/gemini-search.ts` runs Gemini Flash with Google Search grounding in parallel with Grok via Promise.allSettled for daily briefs, Look Ahead, and Sunday Edition Horizon - reaches official event calendars, local news sites, business listings that Grok's X-heavy search misses, anti-repetition via recentTopics param, ~+$0.70/day cost, zero latency increase), Enrichment prompt improvements (one story per section rule and recency-first ordering across daily brief, Look Ahead, and Sunday Edition enrichment prompts), Daily writing quality review cron (samples 3 random neighborhoods' daily briefs and 3 different neighborhoods' look-ahead articles - 7 most recent per neighborhood - sends to Gemini Pro 2.5 and Claude Sonnet in parallel for independent editorial analysis against FT HTSI/Morning Brew/Monocle/Puck/Airmail/Vanity Fair benchmarks, emails HTML report to admin with both analyses at 11 AM UTC daily, full analyses stored in cron_executions.response_data for historical reference, ~$0.27/day, recommendations-only with no automatic prompt changes), Eliminate AI-generated images from all specialized cron articles (28 crons like sync-overture-alerts, sync-museum-watch, sync-gala-watch etc were using getCronImage() which returned cached AI-generated images from Supabase Storage cron-cache - modified getCronImage() to accept optional neighborhoodId and prefer Unsplash library photos via DB lookup when provided, updated all 28 cron callsites to pass neighborhoodId per-article instead of sharing one cached image across all articles, expanded retry-missing-images cron to also detect and replace existing cron-cache AI images with Unsplash photos for backfill), Improve Unsplash image quality with interleaved dual-query search (old approach searched "{name} {city}" with 10 results per query sequentially - new approach runs two parallel searches: "{name} {city}" for disambiguation + "{name}" alone for iconic/popular shots, 30 results each, interleaved and deduped so the final pool alternates city-accurate and visually striking photos; handles ambiguous names like SoHo across cities since city-qualified results take interleave priority; fallback to city-only and city+country queries preserved; 2 API calls per neighborhood well within 5000/hr budget), Fix monitor-and-fix auto-fixer starvation bug (getRetryableIssues fetched only 10 oldest issues - all stale unenriched_brief from Feb 16 - and the route if/else chain was missing handlers for unenriched_brief and missing_hyperlinks so they fell through to skip, causing 1,544 issues to accumulate unresolved; fixed by increasing query limit to 50 with 7-day max age filter and newest-first ordering, adding unenriched_brief/missing_hyperlinks handlers with enrichment rate limiting via new FIX_CONFIG.MAX_ENRICHMENTS_PER_RUN=5, simplifying the dispatch loop to route all fixable types through attemptFix() instead of duplicating type dispatch, and bulk-closing stale issues older than 5 days via migration), Shorten Look Ahead link text from "today and next 7 days" to "next 7 days" across all surfaces (DailyBriefTemplate, SundayEditionTemplate, BriefDiscoveryFooter, assembler cleanCategoryLabel, translations.ts feed.lookAhead and feed.lookAheadCta in all 9 languages), Change Sunday Edition house ad CTA from "Place it Now" to "Place it" in all 9 languages (translations.ts houseAd.sunday_edition.cta), Add information gap teaser to Sunday Edition email subject (Gemini generates 1-4 word cryptic teaser during editorialSynthesis stored in `weekly_briefs.subject_teaser` - zero extra API calls since it's appended to the existing editorial synthesis prompt as a TEASER: line, sender prefers Gemini teaser over headline-based fallback, format matches Daily Brief: `{teaser}, {neighborhood}` all lowercase, fallback `your sunday edition, {neighborhood}`, both send-sunday-edition cron and sunday-edition-request endpoint updated, DB migration adds subject_teaser column to weekly_briefs), Change Daily Brief subject line to lowercase teaser-first format (old "Daily Brief: West Village. Toughest table" wasted 25+ chars on prefix causing truncation, new format "toughest table, west village" puts teaser first with comma separator all lowercase, no "Daily Brief:" prefix, fallback "your morning brief, {neighborhood}", removed "& more" suffix from headline fallback), Replace real ad images with 8 AI-generated placeholder creatives (Emerald Dunes Links golf, Matterhorn Grand ski hotel, Aethelred Yachts, Aether Jets, AURA Z-Fold electronics, Important Property real estate, St Morgan restaurant, AURUM sunglasses - uploaded to Supabase ad-assets bucket as global active paid ads valid for 1 year, 7 daily_brief + 1 sunday_edition placement, expired 2 old Unsplash stock image ads, tagged customer_email placeholder@readflaneur.com for bulk management, upload script at scripts/upload-placeholder-ads.mjs), Fix Look Ahead event listing font jarring (EventListingBlock in ArticleBody.tsx used text-xs/text-sm sans-serif while prose used text-[1.35rem] Merriweather serif - bumped event listing to serif font with text-sm headers and text-[0.95rem] events for smooth transition), Relax tourist filter to stop suppressing legitimate events (broad "any activity primarily marketed to tourists" language caused Grok to self-censor in tourist-heavy neighborhoods like SoHo producing Look Ahead with only 1 event for a whole week - narrowed to specific exclusion list and explicitly encouraged galleries, exhibitions, concerts, pop-ups etc), Fix markdown links rendering as raw text in Daily Brief cards (extractSectionHeader heuristic splits words on whitespace so markdown links like [Bar Maeda](url) get broken across header/rest boundary - now skips header detection entirely when paragraph contains markdown links, this is a rendering bug not a data bug so DB health checks can't catch it), Add anchor links from Look Ahead event listing to day headers (clickable day headers in "At a glance" section smooth-scroll to corresponding day section in prose body below, daySlug() helper generates deterministic IDs, stopPropagation prevents card collapse, hover:text-accent visual hint), Persist active pill selection across browser back navigation (MultiFeed saves activeFilter to sessionStorage so returning from an article page restores the neighborhood pill instead of defaulting to "All Neighborhoods" view, validates saved ID exists in current neighborhoods list, session-scoped via sessionStorage not localStorage), Stop generating briefs and look-aheads for combo component neighborhoods (Djurgarden was getting its own independent daily brief and look-ahead despite being a component of the Ostermalm combo - migration sets is_active=false for all combo components via combo_neighborhoods table, archives incorrectly generated component articles, added combo_neighborhoods exclusion guard in both sync-neighborhood-briefs and generate-look-ahead crons as belt-and-suspenders), Add tourist activity filter to Daily Brief prompts (walking tours, food tours etc excluded from both Grok and Gemini enrichment prompts matching existing Look Ahead filter), Fix Sunday Edition data point headline overlap (dataPointValue style missing lineHeight causing 36px Playfair Display text to overlap on multi-line wrapping in mobile email clients, added lineHeight 1.2), Fix Daily Brief and Look Ahead card appearance (Daily Brief preview now skips AI greeting paragraph like "Morning, neighbors." and shows actual news content via isGreetingParagraph() covering all 9 languages, Look Ahead closed state puts "Read more" on its own line for cleaner layout, Look Ahead expanded state shows highlighted summary block at top with bg-canvas/50 rounded-lg before event listing), Sunday Edition admin test page (one-click generate/preview/send for any neighborhood on any day at /admin/sunday-edition, preview endpoint renders full email HTML with subject line, article URL safety fix verifies article exists before constructing "Read the full edition" link in both send-sunday-edition and sunday-edition-request endpoints), Fix Sunday Edition data point voice and past holiday detection (Data Point prompts changed from "we/our" possessive to neighborhood name references - "The Tribeca median listing" not "Our median listing", detectUpcomingHoliday now anchored to publication weekDate instead of generation time preventing past holidays like Mardi Gras from appearing in later editions), Fix Sunday Edition throughput (concurrency 3->5, schedule extended to Saturday+Sunday hourly so all 270 neighborhoods get briefs before Sunday morning sends), Morning Brew-style information gap email subject lines (Gemini generates 1-4 word cryptic teasers during enrichment stored in `neighborhood_briefs.subject_teaser` - zero extra API calls, sender prefers Gemini teaser over headline-based fallback, format: "Daily Brief: {Neighborhood}. {teaser}" e.g. "Daily Brief: West Village. Rent freeze showdown"), Silence GoTrue AbortError in Sentry (navigator.locks 'signal is aborted without reason' added to ignoreErrors), Disable Civic Data story generation (removed 5 crons from vercel.json - generate-nyc-weekly-digest, generate-global-weekly-digest, sync-global-permits, sync-global-liquor, sync-global-crime; archived 23 existing published articles), Change advertise house ad CTA to "Place It", Fix article back link going to /city/neighborhood instead of /feed (BackToFeedLink and MoreStoriesButton now always link to /feed so readers return to their multi-neighborhood feed with pills), Fix Look Ahead repeating same venue across multiple days (NO REPETITION rule in both Grok and Gemini prompts - each day must feature different events, skip days rather than pad with repeats), Add structured event listing to Look Ahead articles (Grok returns EVENTS_JSON alongside prose, TypeScript formatEventListing() groups by date with dedup for recurring events and address cleaning, compact "At a glance" rendering in ArticleBody EventListingBlock and LookAheadCard with grey bullets and middot separators, suppressed duplicate CTAs on editorial article pages), Fix nuisance watch date precision and images (date range ends yesterday with "from and including X through and including Y" format, bullet list spacing improved, switched from AI-generated getCronImage to Unsplash selectLibraryImage), Update Look Ahead label to "today and next 7 days" and primary brief text to "Daily Brief and Look Ahead" across all 9 languages and email templates, Update Sunday Edition house ad text ("living in" instead of "native in", "Place it Now" CTA) across all 9 languages + DB, Fix Look Ahead cron to generate for combos not components (combo neighborhoods like Tribeca, Ostermalm, Hamptons now get one consolidated Look Ahead article covering all component areas matching Daily Brief pattern - switched from getActiveNeighborhoodIds + is_combo=false filter to is_active=true query, added getComboInfo component name expansion for Grok search), Fix Look Ahead API for combo neighborhoods (Ostermalm and Tribeca returned null because articles stored under component IDs like stockholm-ostermalm-core - API now queries combo_neighborhoods table to expand combo IDs), Fix Look Ahead card teaser and expanded formatting (preview strips all markdown before sentence extraction - was showing raw markdown links, teaser renders as plain muted grey text matching Daily Brief style, body preprocessed with paragraph breaks around [[Day, Date]] headers so "Today," starts on new line), Fix Daily Brief card date using browser timezone instead of neighborhood (Waiheke Island UTC+13 showed FRI FEB 20 from Stockholm UTC+1, added timezone prop to NeighborhoodBrief passed from all 4 render sites), Fix Look Ahead same-day local time generation (cron used UTC date math causing articles to appear a day early - added per-neighborhood local date computation via getLocalPublishDate(timezone), published_at set to 7 AM local, cron schedule changed from `0 17-22` to `0 0-7`, Grok receives local date instead of UTC tomorrow), Look Ahead card formatting (label changed to "Look Ahead (next 7 days)" in all 9 languages, one-sentence teaser in closed card via regex, extra mt-6 on day headers when expanded), Newsletter auto-subscribe on login and signup (auto-insert into newsletter_subscribers during both signin API and auth callback, admin client bypasses RLS, ensures all registered users get Daily Brief emails), Fix sort_order column references causing 24h neighborhood sync outage (user_neighborhood_preferences has NO sort_order column - removed from 8 files that silently failed with Supabase returning error objects on non-existent columns), Profile data caching (signin API fetches profile in parallel, login page writes to flaneur-profile localStorage, account page reads instantly on mount - no grey flash), Turnstile sitekey trim (env var had trailing newline), Fix login auth - Header SIGN IN bug + mobile login hang (Header now checks flaneur-auth localStorage FIRST for instant "Account" display then getSession in background - never clears user on null session fixing SIGN IN flash with expired JWT; login page removed flaneur-auth redirect shortcut breaking redirect loop when cookies expired; login handleSubmit rewritten to server-only POST /api/auth/signin with zero navigator.locks calls reducing mobile login from ~7-8s to ~1-2s; signin API validates Turnstile token server-side via Cloudflare siteverify; 3 files: Header.tsx, login/page.tsx, api/auth/signin/route.ts), Fix global neighborhood date stamping in briefs (Grok and Gemini enrichment now receive IANA timezone from DB - expanded country-timezone fallback map from 7 to 42 entries, Grok receives explicit local date in search query and system prompt, Gemini gets DATE CORRECTION instruction to fix day-of-week/date references to match neighborhood's local date at 7 AM delivery time; 9 files updated: brief-enricher-gemini.ts, grok.ts, 5 cron routes, neighborhoods/create, briefs/enrich-gemini, auto-fixer.ts), Fix Account page auth (removed destructive signOut auto-heal that destroyed sessions when getSession returned null, added 3s Promise.race timeout matching Header pattern, flaneur-auth localStorage fallback for userId/email detection, fixed useEffect dependency from [loading] to []), Full bidirectional neighborhood sync (DB is authoritative for logged-in users; `useNeighborhoodPreferences` fetches DB prefs on mount and on `visibilitychange` tab focus, overwrites localStorage + cookie; removals on one device propagate to others within 30s of tab focus; 30s throttle prevents excessive DB calls; Header SIGNED_IN always overwrites localStorage from DB; login page and auth callback also sync DB to local; layout inline script does cookie-to-localStorage reverse sync pre-hydration), Inline article reactions with source attribution (bookmark/heart buttons moved from below bottom ad to right-aligned on the same row as source attribution text, SourceAttribution accepts `actions` ReactNode slot, ArticleReactions rendered inline without standalone margin, non-AI articles still show reactions via fallback wrapper), Fix password reset email expiry text (said "24 hours" but Supabase OTP expiry is 1 hour - corrected to "1 hour"), Require explicit calendar dates in all AI-generated content (all prompts - Gemini enrichment, Grok briefs/news/look-ahead, Claude RSS rewrites, crime blotter - now require explicit dates alongside relative time references like "yesterday (February 19)" or "this Thursday, February 20" so articles remain clear days after publication), Crime blotter source attribution (cron now collects unique sources from Grok incident data - NY Post, @NYPDnews, Citizen, etc. - and inserts them into article_sources table; SourceAttribution shows "Synthesized from reporting by..." with named sources instead of generic "public news sources"), Expandable Look Ahead card with discovery CTAs (card below Daily Brief now expands/collapses showing full article content with day headers and "Keep Reading" links - yesterday's brief, nearby brief, take me somewhere new; compact closed state unchanged; removed redundant Look Ahead CTA from Daily Brief expanded view), Neighborhood-aware article back links (BackToFeedLink and MoreStoriesButton now link to /{city}/{neighborhood} instead of bare /feed), Move feed neighborhood IDs from URL params to SameSite=Strict cookie (neighborhoods were passed as query params creating long ugly URLs and abuse vector - now stored in cookie synced from localStorage, `feed/page.tsx` reads `cookies()` instead of `searchParams`, layout inline script syncs cookie on every page load, all navigation points updated to sync cookie before `router.push('/feed')` or `router.refresh()`, Header neighborhood links now point to `/{city}/{neighborhood}` pages, `src/lib/neighborhood-cookie.ts` utility), Fix Look Ahead date showing published_at instead of created_at (articles created evening before showed "Feb 19" while content said "Today, Friday February 20" - now uses `published_at` for look_ahead articles across CompactArticleCard, ArticleCard, and article detail page), Disable Social Calendar (Gala Watch) story generator (removed `sync-gala-watch` cron from vercel.json, archived existing articles via SQL migration, removed from email preferences), Fix Look Ahead generation for combo neighborhoods (Tribeca, Hamptons, Ostermalm never got Look Ahead articles because getActiveNeighborhoodIds() didn't expand combo IDs to component IDs - components like nyc-tribeca-core have is_active=false so were filtered out; added step 4 to expand combos and removed is_active filter from generate-look-ahead cron since the active set already determines eligibility), Image feedback tooltip text ("I like this image" / "I don't like this image"), Image thumbs up/down feedback on article pages (`image_feedback` table keyed on `image_url` for cross-article aggregation, `ImageFeedback.tsx` client component with optimistic UI + anonymous_id persistence, `GET/POST /api/image-feedback` endpoint, inline with Unsplash credit line or right-aligned below AI image disclaimer, active up=amber active down=red, score shows `+N`/`-N` when non-zero), Shareable neighborhood feeds and daily brief share button (reusable `ShareButton` component in `src/components/ui/ShareButton.tsx` with `icon` and `text` variants  icon variant in NeighborhoodBrief eyebrow row, text variant in NeighborhoodHeader control deck alongside Guide/Map/History and in mobile overflow menu, also in MultiFeed masthead when a pill is active; uses `navigator.share()` with `navigator.clipboard.writeText()` fallback, `stopPropagation` prevents brief card expand/collapse; all share URLs point to clean `/{city}/{neighborhood}` paths built via `getCitySlugFromId`/`getNeighborhoodSlugFromId`; `shareUrl` prop on NeighborhoodBrief passed from 3 render sites: `[city]/[neighborhood]/page.tsx`, `feed/page.tsx` single+multi, `MultiFeed.tsx` fetched pill brief; translations for `share.share` and `share.copied` in all 9 languages), Neighborhood-local date display (article dates now render in the neighborhood's IANA timezone instead of the browser's timezone  e.g., a Shibuya brief generated at midnight JST shows "Feb 21" regardless of reader location; `formatDate()` and `formatRelativeTime()` in `utils.ts` accept optional `timezone` param passed via `article.neighborhood?.timezone`; ArticleCard shows "7h ago  Feb 21" format for < 7 days, CompactArticleCard shows "Fri, Feb 21" in local tz, article detail page same; all 5 feed query files updated to include `timezone` in neighborhood JOIN), Per-neighborhood article read tracking in localStorage (ArticleViewTracker tracks reads per neighborhood_id with 30-day pruning), PrimaryChangeSuggestion component (suggests primary neighborhood change based on reading patterns), Escape Mode house ad (new `escape_mode` type in house_ads rotation - headline "Activate Escape Mode", body describes luxury mini-vacation, CTA button "Take me somewhere new" linking to random neighborhood's latest Daily Brief via `findDiscoveryBrief()` with `mode: 'random'`; NativeAd.tsx renders optional `ctaText` as dark button, EmailAd type extended with `ctaText?: string`, ads.ts resolves dynamic URL at email assembly time, FallbackAd.tsx resolves client-side for web; DB migration added `escape_mode` to CHECK constraint + seeded ad with weight 2), Morning Brew-inspired email improvements (footer "forwarded to you?" CTA in Footer.tsx and SundayEditionTemplate, welcome email deliverability coaching with platform-specific inbox tips in subscribe/route.ts buildMagicLinkEmail(), welcome email "Here's what to expect" 2x2 grid showing Daily Brief/Look Ahead/Sunday Edition/Family Corner/Escape Mode, inline referral CTA after primary stories in DailyBriefTemplate and before footer in SundayEditionTemplate when referralUrl exists, share links on lead story in StoryList.tsx with Twitter intent + Facebook sharer URLs for isPrimary && i === 0, improved email divider hierarchy - primary story dividers #d5d5d5, full-width #999999 divider between primary and satellite sections, satellite section dividers full-width #e0e0e0, light #e5e5e5 dividers between satellite stories), Hide test neighborhoods from non-admin users (API filters `region != 'test'` for non-admins in `/api/neighborhoods/route.ts`, client-side cleanup of stale selected IDs in `NeighborhoodSelectorModal.tsx`, DB migration removed test neighborhood prefs for non-admin users), Update Unsplash cron to every 4h (production API approved at 5000/hr, changed `refresh-image-library` from `5 * * * *` to `0 */4 * * *`), Family Corner quality fixes (strip Grok citation URLs from body text via 4-pattern regex in generate-childcare-content.ts, add Gemini Flash enrichment step after Grok for polished per-age-band content using direct 35-year-old parent persona ("you/your" voice, not insiderPersona()), improve Grok prompt to require dedicated content per age group and restrict to 3-day window (today + next 2 days), show neighborhood name in email header "FAMILY CORNER  TRIBECA" with "For your primary neighborhood" note, neighborhoodName field added to FamilyCornerSection type and passed from assembler, FamilyCornerSection.tsx parses **BandLabel:** markdown into separate paragraphs with bold headers instead of rendering as one wall of text), Fix feed ordering stability (added `created_at DESC` as secondary sort in feed/page.tsx, MultiFeed.tsx, MultiLoadMoreButton.tsx, LoadMoreButton.tsx  Look Ahead articles all share the same `published_at` timestamp causing unstable ordering; `published_at DESC, created_at DESC` ensures deterministic results), Fix Look Ahead date display (hide date in CompactArticleCard for `look_ahead` articles  showing "Fri, Feb 20" on a Thursday was confusing; the "Look Ahead" category label already conveys forward-looking nature), Fix Unsplash AI badge in CompactArticleCard (added `!article.image_url.includes('unsplash.com')` guard matching ArticleCard.tsx  compact/list view was showing AI badge on real Unsplash photos), Fix Look Ahead "Good morning" greeting bug (FORMATTING RULES in brief-enricher-gemini.ts unconditionally required morning greeting for ALL article types, overriding lookAheadStyle's "NO greeting"  made greeting conditional: only daily_brief gets "Good morning", look_ahead and weekly_recap get "Do NOT include any greeting"), Family Corner preferences UX polish (changed "Save Children" button to "Save Children Changes", post-save shows green "Children changes saved" confirmation replacing the button, age band preview shows immediately when children are entered instead of only after save), Family Corner house ad promotion (new `family_corner` house ad type in DB with weight 5, FallbackAd.tsx renders with dismiss X button, suppressed when `flaneur-family-corner-enabled` localStorage is set or after 3 dismissals via `flaneur-family-corner-ad-dismissed` counter, excluded from email house ads via `.neq('type', 'family_corner')` in ads.ts, translated to 9 languages), Family Corner UX polish (prominent styled-box toggle confirmation instead of tiny green text, age band preview after saving children showing content categories per band, description text includes "tailored to your children's ages"), Family Corner UX improvements (separate Email Preferences link on Account page, #family-corner hash scroll+highlight when navigating from Account, guidance when enabled but no children entered, "Paused" instead of "Disabled" when children details saved, updated description text on both pages), Fix missing blurbs on Look Ahead articles in compact feed view (CompactArticleCard now falls back to body_text when preview_text is empty  all Look Ahead articles had empty preview_text causing blurb-less cards that buried NYC daily briefs below 22 Look Ahead cards in All Stories view; also backfilled preview_text for 22 today's Look Ahead articles from body_text via SQL), Fix multi-neighborhood feed showing only 10 articles (dynamic feedLimit scales with neighborhood count: min(n*3, 60) instead of fixed 10, prevents briefs from most neighborhoods being cut off; also fixed "Your curated feed from 0 locations" flash during page transitions by passing undefined instead of 0 to NeighborhoodHeader), Persona switcher now hides Admin/Dashboard nav links (added data-admin attribute to Header nav links so PersonaSwitcher CSS targeting [data-admin] actually works in subscriber view), Add timezone delivery hints (neighborhood selector modal and account page explain timezone sets email delivery time at 7 am local and doesn't affect neighborhood selection), Family Corner discoverable from account page (shows enabled/off status, description, link to preferences page with user's unsubscribe token), Family Corner immediate content generation (fire-and-forget triggers generate-childcare-content cron when user saves children, warm thank-you message sets expectations about next Daily Brief), Family Corner opt-in childcare section in Daily Brief (age-band-aware family content for opted-in users - user_children table stores birth month/year, childcare_content caches Grok-generated content once per neighborhood+age-band combo per day at 4 AM UTC, FamilyCornerSection email component after satellites, preferences API/UI for enable/disable + 1-4 children with month/year dropdowns, zero cost for non-opted users via early childcare_mode_enabled check in assembler.ts, 4 age bands auto-calculated: infant 0-18mo / toddler 19mo-5yr / school_age 5-12yr / teen 13-18yr, 3-day content window: "Today" + "Next 2 Days" per age group, 35yo parent persona writes as "you/your" not "our/residents"), Smarter Google verify link for globally syndicated stories (SourceAttribution buildSearchQuery omits neighborhood for Auction Watch/Gala/Overture/Museum/Route Alert category labels), Require local language greetings/sign-offs/phrases in briefs (changed from optional 'you may sprinkle' to mandatory 'ALWAYS include' in brief-enricher-gemini.ts - Daily Brief greeting must be in local language e.g. 'God morgon, grannar.' for Stockholm, sign-off in local language, 1-2 local terms woven through body), Fix Load More button loading all neighborhoods when pill filter active (MultiLoadMoreButton was outside MultiFeed so it ignored activeFilter state - moved inside as loadMoreAll prop that only renders when no pill is selected), Remove duplicate inline persona constants from 6 crons (archive-hunter, fashion-week, political-wallet, route-alert, residency-radar, nimby-alert had stale SYSTEM_PROMPT constants passed as `systemInstruction` that lacked banned outsider phrases - removed so only shared `insiderPersona()` from `ai-persona.ts` is used in user prompt), Ban outsider phrases in `insiderPersona()` in `ai-persona.ts` ("for those in the know", "the elite", "Manhattan's elite", "if you know you know", "the usual suspects", "movers and shakers"), Fix gala-watch Gemini prompt to use actual event dates (was saying "tonight" regardless of when event occurs) and matter-of-fact tone, Unify AI writing persona across all prompts (Claude Sonnet 6 cron prompts + Gemini Flash/Pro 30+ lib files use shared `insiderPersona()` from `src/lib/ai-persona.ts` for consistent "35-year-old resident" voice; Grok reverted to neutral fact-gatherer identity since persona restrictions limited fact coverage and Gemini enrichment applies voice downstream), Fix combo neighborhood feed queries (feed page and MultiFeed pill filter didn't expand combo IDs to include component neighborhoods - e.g., selecting `nyc-tribeca` missed articles under `nyc-fidi` or `nyc-tribeca-core`; article detail page now shows parent combo name in breadcrumb for component neighborhood articles), Fix generate-brief-articles broken SELECT (used `ai_model` but DB column is `model`  fixed to `brief.model`), Fix assembler fallback article creation (when generate-brief-articles hasn't run, `fetchBriefAsStory()` in assembler.ts creates brief_summary articles  was missing source extraction/insertion, enriched_at/enrichment_model, and had hardcoded ai_model instead of using brief's actual model), Suppress "verify here" on editorial content (SourceAttribution now accepts `category` prop  brief_summary/look_ahead/weekly_recap articles skip single-source verification since they're AI-generated editorial), Add sanitizeMarkdownLinks() to hyperlink-injector.ts (fixes Gemini URLs containing literal parentheses like `(PACT)` or `(NYC)` that break markdown link parsing  called in brief-enricher-gemini.ts), Expand health monitor to 9 checks (added Check 8: Editorial Sources  detects brief_summary/look_ahead/weekly_recap articles with sources, auto-fixes by deleting inappropriate source rows; Check 9: URL-Encoded Text  detects `%20`/`%2C`/etc. in article bodies, auto-fixes via decodeURIComponent; both wired into auto-fixer.ts and monitor-and-fix/route.ts), Fix Look Ahead cron logging (added `articles_created` to cron_executions INSERT in generate-look-ahead/route.ts), Redesign weather story in Daily Brief email (render non-alert stories as subtle grey 13px text inline with temperature hero block instead of bold standalone card, each sentence on its own line to prevent word-wrap, "% prob" instead of bare "%", alerts priority 1 still render as red-bordered WeatherStoryCard, replaced "Commute" with "Travel" in all weather story labels, restored Google weather search link on temperature), Fix 11 broken article-generating crons (Group A: relax political-wallet thresholds  lookback 730d, trigger $10K$2.5K, donor $1K$500; fix heritage-filings lookback 24h336h + add `nyc-` prefix to neighborhood IDs. Group B: replace 9 broken data fetchers with `grokEventSearch()`  overture-alert and museum-watch TODO stubs implemented, sample-sale/gala-watch/route-alert/residency-radar/archive-hunter broken HTML scrapers replaced, nyc-auctions/global-auctions fake API endpoints replaced. All use shared `grokEventSearch()` in `grok.ts` with `web_search` + `x_search` tools. Each call batches all items into 1-2 prompts (not per-item) to stay under 300s timeout. Existing Gemini story generation and Blue Chip/brand/venue validation filters untouched), Rewrite liquor license cron with public NY State datasets (old `wg8y-fzsj` required auth  switched to pending `f8i8-k2gm` + active `9s3h-dpkz`, generates "Last Call" articles via Gemini Flash, parallelized batches of 5, placeholder image for timeout safety, `nyc-` prefix fix for neighborhood IDs), Fix nuisance watch empty locations (NYC 311 complaints with empty `street_name` and non-numeric `incident_address` produced empty `displayLocation` causing headlines like "Noise complaints spike on " - `anonymizeAddress()` now has 3-layer fallback: `street_name` -> extract street from `incident_address` -> cross streets, plus `titleCase()` for ALL CAPS 311 data and "0 Block of..." suppression, `clusterComplaints()` skips unresolvable locations, 6 broken articles unpublished), Government source attribution for NYC open data crons (SourceAttribution parses `editor_notes` for `Source: Name - URL` pattern, shows direct government database link instead of Google verify for nuisance watch/filming permits/alfresco permits/retail watch/NIMBY alerts, 93 existing articles backfilled), Community neighborhood premium UX (executive status application when 2-credit limit reached, self-delete within 24h with 0 followers, community reporting, luxury 'Initializing Coverage Protocol' empty state for new community neighborhoods), Fix Daily Brief writing quality (Phase 2 of enrich-briefs was re-enriching brief_summary articles with weekly_recap style stripping the "Good morning" greeting - now skips brief_summary and look_ahead articles, Pro always used for briefs / Flash for RSS articles, reinforced greeting as CRITICAL formatting rule, added neighborhood+date dedup in generate-brief-articles, fixed hardcoded enrichment_model, admin-only model label on article pages), Replace AI-generated images with Unsplash stock photos (real neighborhood photos instead of hallucinated Imagen 4 scenes, $0/quarter vs ~$90/quarter, Unsplash CDN hotlinking per their terms, photographer attribution on article pages, hourly cron backfill at 50/hr demo rate limit pending production API approval for 5000/hr), Force "Flaneur News" sender name (EMAIL_FROM env var had "Flaneur" display name which bypassed regex - now extracts email address and always wraps with "Flaneur News"), Improve Daily Brief subject teaser (use full lead headline + "& more" instead of boring 2-4 word fragments), Add "+" to preview text when multiple neighborhoods ("Your morning brief from Tribeca+"), Add teaser subject lines for Daily Brief ("Daily Brief: {Neighborhood}. {lead headline} & more") and Sunday Edition ("Sunday Edition: {Neighborhood}. {teaser}") under 70 characters, Fix Supabase security advisor issues (enable RLS on article_sources, set search_path on 10 functions, tighten legacy table INSERT policies, add community_creation_rejections policy), Add border/frame to house ad in Daily Brief and Sunday Edition emails (NativeAd.tsx gets 1px solid border with 4px radius replacing Hr dividers; SundayEditionTemplate sponsor section same treatment), Move house ad to after all primary stories in Daily Brief (was between story 1 and 2), Rename email category labels ("Daily Brief" to "Daily Brief (Today)", "Look Ahead" to "Look Ahead (next 7 days)" via cleanCategoryLabel in assembler.ts), Remove CSS line-clamp from email preview text (was causing Gmail to render "..." dots instead of story content; now relies solely on truncateAtSentence(160) for clean sentence-boundary truncation), Add satellite neighborhood preview text blurbs in email (SatelliteSection.tsx was only rendering headlines with no preview text; now shows 160-char sentence-truncated blurbs matching primary neighborhood style), Add "(next 7 days)" to Look Ahead link text (updated in BriefDiscoveryFooter, NeighborhoodBrief, DailyBriefTemplate, SundayEditionTemplate), Fix Look Ahead headline format (cron was generating "{Name} LOOK AHEAD: {headline}" causing redundant neighborhood name on article pages; changed to "LOOK AHEAD: {headline}", updated 12 existing headlines in DB), Fix image library generator count bug (generateNeighborhoodLibrary was adding partial generation count to previous season's count via images_generated, inflating to 8 even when rate-limited mid-run; now uses only current run's count for full refreshes, fixed DB counts for 3 affected neighborhoods), Fix Look Ahead "Keep reading" links (added look_ahead variant to BriefDiscoveryFooter showing "Read today's Daily Brief", hides self-referential Look Ahead link, fixed "Add to neighborhoods" showing for already-subscribed neighborhoods by using article.neighborhood_id from DB instead of buildNeighborhoodId), Strip redundant LOOK AHEAD/DAILY BRIEF prefix from headlines in email and feed (cleanHeadline in assembler.ts and cleanArticleHeadline in utils.ts), Fix Look Ahead coverage (was only processing 12/257 neighborhoods per day - cron ran once at 8 PM UTC and hit 270s time budget; changed to hourly 5-10 PM UTC with dedup + concurrency 3->5, all 257 now covered), Fix broken library image URLs (selectLibraryImage was returning URLs for non-existent files since only 9/257 neighborhoods had generated libraries; added getLibraryReadyIds() check to all 6 article-creating crons, returns empty string for neighborhoods without libraries so retry-missing-images fills them), Pre-generated neighborhood image library (8 images per neighborhood via Gemini Pro creative director + Imagen 4 generation, rotated by article type and day-of-year, eliminates per-article Gemini Image calls reducing cost from ~$750/mo to ~$30/mo, admin batch generation endpoint, automated every-4h generation cron with Imagen 4 70 RPD quota awareness, manual upload script with Gemini watermark removal + sharp resize to 1280x720, status dashboard sorted by subscriber priority, library-first fallback in generate-image endpoint, DB status tracking table, community neighborhoods generate library on creation), Look Ahead article feature (daily forward-looking articles covering tomorrow + next 7 days - hourly cron 5-10 PM UTC for 7 AM local delivery next morning: Grok search -> Gemini Flash enrichment -> article creation, neighborhoods prioritized by delivery urgency so APAC/East processed first, prompts frame content from reader's next-morning perspective, only for neighborhoods with active subscribers, LookAheadCard below daily brief in feed, Look Ahead CTAs in expanded briefs and BriefDiscoveryFooter, links in daily brief and Sunday Edition emails, active-neighborhoods.ts resolver, translations for all 9 languages), Continuity context for Gemini enrichment (feeds last 5 days of enriched briefs + last 3 days of articles into prompt so Gemini can reference prior coverage naturally - "as we noted Tuesday..."), Google Search verification link for single-source articles (SourceAttribution shows "verify on Google" link when sources <= 1, searches headline + neighborhood name), Day-of-week in feed date metadata (compact/gallery/brief cards show "Mon Feb 17" instead of "Feb 17", auto-translated via Intl.DateTimeFormat locale), "Front door" homepage experience (new visitors see full cinematic hero + "Read Stories" CTA instead of auto-redirect, returning users still instant-redirect via layout script, /discover accessible via footer logo + ContextSwitcher "The Front Door" link), Fix sticky pills syncing with header hide/show (--header-offset CSS variable, back-to-top moved to bottom-right on all screens), Fix health check brief coverage false positives (was using UTC midnight as "today" but cron uses per-timezone local dates with 36h lookback - APAC briefs generated before UTC midnight were falsely missing; also skips neighborhoods whose morning window hasn't passed yet), 3x brief generation throughput (sequential -> concurrency 3 Grok calls, was only generating ~9 briefs per run), 6x translation throughput (was only translating 26% of articles - concurrency 3->8, schedule */30->*/15, removed 30-per-language cap, Phase 1 budget 60%->75%), Fix translation stale state bug (switching languages left old translation on screen when new one didn't exist - now clears state before fetch in all 4 translation-fetching components: CompactArticleCard, ArticleCard, TranslatedArticleBody, NeighborhoodBrief), Fix email primary neighborhood mismatch (added primary_neighborhood_id to profiles table - scheduler was using ambiguous city-matching which picked wrong neighborhood when user had multiple in same city, now stores exact ID via sync-primary endpoint with city-based fallback), Fix forgot password flow (PKCE code exchange on reset-password page, send reset email via Resend instead of Supabase for inbox deliverability, fix Supabase Site URL from localhost to readflaneur.com), Pro-first Flash-fallback enrichment strategy (uses gemini-2.5-pro for first 900 requests/day then cascades to gemini-2.5-flash, preserves Pro quality for majority of briefs while staying within 1K RPD limit), Daily content health monitor cron (7 automated checks at 10 AM UTC - brief coverage, content quality, hyperlinks, HTML artifacts, translation coverage, email delivery, story images - creates cron_issues for auto-fixable problems and emails admin summary report), Fix Daily Brief card hyperlink stripping (negative lookbehind regex preserves markdown links in NeighborhoodBrief cleanContent), Strengthen link_candidates in Gemini enrichment (mandatory for all content types including weekly recaps), Add time budget to sync-neighborhood-briefs (270s of 300s maxDuration prevents silent kills with no logging), Sunday Edition concurrency + parallelization (3x concurrent neighborhoods in cron route + parallel Horizon/DataPoint/Holiday sections in generateWeeklyBrief for 2-3x faster generation), Sunday Edition Sunday-context enrichment (weeklyRecapStyle explicitly states "write as if it is Sunday" even when processed later), Move sign-out to /account page for infinite session pattern, Add retry-missing-images cron to fill failed article images, Filter empty image_url strings in feed image fallback, Fix Header auth persistence (getSession() deadlock via navigator.locks from GoTrue _initialize(), 3s timeout + onAuthStateChange only handles positive events, router.push client-side nav after login, removed getUser() from middleware that was clearing cookies, loading guard prevents SIGN IN flash), Fix Sunday Edition not sending (Daily Brief skips Sundays so it doesn't block Sunday Edition dedup, sync-weekly-brief batch increased from 10 to 500 to cover all 270 neighborhoods), Fix login/auth split-brain state (login redirects authenticated users to /feed, account page auto-heals stale localStorage tokens, sign-out clears both client+server state, GoTrue REST API bypass for broken CAPTCHA), Translate house ad text (headlines, body, CTAs) into 9 languages with type-specific CTA buttons and {neighborhoodCount} placeholder handling, Translate all 5 footer pages (about, legal, standards, contact, careers) into 9 languages with server/client splits for metadata + translation sync checker script, Preserve markdown links in Gemini enrichment pipeline (was stripping [text](url) before saving to DB so render-time fix had nothing to work with), Change share title to "Check out Flaneur" (was "Join me on Flaneur" which Outlook rendered as "Url from [name]"), Reduce header spacing between Stories and theme/language icons, Fix inviter detection on /invite (check auth session + localStorage neighborhoods, not just newsletter-subscribed flag), Restore hyperlinks in daily briefs and article bodies (HTML tags converted to markdown, markdown links rendered as clickable <a> elements instead of stripped), Rename "All Stories" to "All My Neighborhood Stories" on article pages (all 9 languages), Add spacing between neighborhood name and Edit Neighborhoods link on feed, Dual-mode invite page (subscribed users see share UX with copy link + native share + referral stats; invitees see join form unchanged) + fix subscribe CAPTCHA bypass (admin generateLink + Resend instead of signInWithOtp), Streamline invite page (remove manual neighborhood selection, auto-detect location on subscribe, "Join" instead of "Subscribe", dynamic house ad neighborhood count), Fix "Read yesterday's Daily Brief" to use date-relative queries (beforeDate instead of excludeSlug, ensures yesterday is relative to the brief being viewed), Change "Daily Brief for your primary" to "Above is the Daily Brief for your primary" in all 9 languages, Fix translate-content cron starvation (LIMIT 20 only translated newest 20 items, never reaching 800+; now uses 4-step ID-first approach) + fix broken cron logging (wrong column names caused 0 logged runs), DB cleanup of corrupted articles (7 specialized articles with Gemini refusal bodies deleted, 107 unprotected articles retroactively given enriched_at), Systemic enriched_at fix across all 27 article-creating crons (prevents enrich-briefs Phase 2 from overwriting specialized article bodies with daily brief content), Fix nuisance watch articles overwritten by enrich-briefs (set enriched_at at creation), Mobile feed vertical space fix (hide MagicLinkReminder on mobile, tighten daily brief spacing), Headline truncation dangling preposition strip (for/in/at/on/to/of/by/with/from/into/as/the/a/an/and/or/but), Translation completeness sweep (wire remaining UI strings through t(), translate Daily Brief category labels, article page brief headline via TranslatedHeadline, cron language rotation for fair zh/ja coverage), Daily brief discovery system (yesterday's brief + nearby + "take me somewhere new" CTAs on expanded briefs and brief article pages, unified "Keep reading" footer with integrated email capture), Compact article reactions (bookmark/heart only, no fire, inline), Gallery story separators, House ad single-line headlines, Article body Grok leak stripping, Daily brief primary neighborhood context in all-stories view, Shift brief generation window to midnight-7 AM (was 3-9 AM) for reliable email delivery, Render markdown hyperlinks in article body and brief content as clickable links (HTML tags converted to markdown format, stripped raw URLs and citation markers), Mobile gallery single-line headlines (no wrap, truncated at last full word) + wider story spacing (space-y-14), Editorial photo image style (watercolor  photorealistic fashion photography of iconic locations), Per-neighborhood default fallback images (stored in storage, checked before article fallback), Gallery mobile layout (headline-first, truncated metadata, 4-line blurb), Tighten headline generation prompts (80 chars  50 chars across sync-news/Grok briefs/Grok stories), Fix mobile dropdown "All Stories" light mode contrast (text-white to text-fg), Block AI scrapers via robots.txt (21 bots), Wire translations into remaining components (EmailCaptureCard, MagicLinkReminder, MultiFeed "My Neighborhoods", ArticleCard gallery headlines), Remove auto-linking from articles and briefs (render-time entity detection + pipeline hyperlink injection disabled), Mobile headline truncation (40-char word-boundary truncation, strip dangling prepositions/articles/conjunctions/St.), Strip DAILY BRIEF prefix from feed headlines + mobile brief headline wrap, Add Portuguese/Italian/Simplified Chinese (9 languages), Language toggle globe icon + mobile fix, Stripe webhook secret trim fix, Mobile feed card layouts (compact: metadata+headline above image on mobile, gallery: metadata+headline above image with 2-line wrap, gallery spacing), Language translation system (batch pre-translation via Gemini Flash cron, 9 languages, LanguageToggle UI, translated articles/briefs/UI chrome), Search page UX (close button, rounded corners, luxury styling), Feed empty state CTA (Choose Neighborhoods button opens modal), Theme accent fix (theme-aware accent color, hamburger chip contrast, scroll-close threshold), Full light/dark theme system (CSS variables, useTheme hook, ThemeToggle, semantic Tailwind classes, flash prevention, force-dark hero), Mobile ViewToggle moved above feed (not in dropdown row), Fix generate-brief-articles cron (batch=10 starved 260+ neighborhoods, now processes all in one pass with 36h window), mobile dropdown "Explore" link + empty search -> Community Created tab, rename Community -> Community Created in selector, Mobile neighborhood dropdown (replaces pill scroll on mobile, full list in one tap), Signup page polish (remove role picker, rounded corners, default reader), enrichment-gated brief publishing (email + article cron skip unenriched briefs), custom SMTP via Resend for auth emails, Cloudflare Turnstile CAPTCHA on signup/login, standards page restyle, mobile view toggle consolidation, Mobile UX overhaul (navigation wayfinding, feed layout, selector fixes, auth flow, ad grace period), Community neighborhoods (user-created neighborhoods with AI validation + full brief pipeline), "Create Your Own Neighborhood" house ad, community neighborhoods TypeScript fixes (openModal signature, GlobalRegion exhaustiveness), global 5-email-per-day limit, always-resend on primary neighborhood change, Vercel preview build fix (lazy-init Supabase admin in 6 routes), Hamptons component renames (removed redundant suffix), brief content sanitization fixes (nested-paren URLs, URL-encoded artifacts), neighborhood selector tidy (renames, region consolidation, new neighborhoods), single-line feed headlines, enrichment language/framing fixes, brighter brief section headings, "Suggest a Neighborhood" house ad + contact form + admin page, dynamic house ads ("Check Out a New Neighborhood" with discovery brief links), Add to Collection CTA on article pages, bare /feed redirect, Grok search result sanitization, Sunday Edition holidays expanded (19  50 across 20 countries), tracked referral system, primary neighborhood sync, Gemini model switch (2.5-pro), feed article dedup, engagement-triggered email capture, smart auto-redirect.

### Email Capture (Engagement-Triggered)
- **Trigger:** `flaneur-article-reads` localStorage counter incremented in `ArticleViewTracker`. Threshold: 3 reads.
- **Placement 1 - Feed inline:** `EmailCaptureCard` injected after 5th article via `injectEmailPrompt()` in `ad-engine.ts`. "Get {neighborhood} stories in your inbox" + email input. Dismiss stores `flaneur-email-prompt-dismissed`.
- **Placement 2 - Article page:** `PostReadEmailCapture` after `ArticleReactions`. Compact inline: "Enjoying {neighborhood} stories? Get them daily."
- **Placement 3 - Return visit:** `ReturnVisitPrompt` in global layout. `flaneur-session-count` incremented once per session (sessionStorage guard). Shows slide-up toast on 2nd+ session with 3+ reads. Auto-dismisses after 10s unless interacted.
- **All prompts:** Hidden when `flaneur-newsletter-subscribed` = `'true'` or `flaneur-email-prompt-dismissed` = `'true'`. Posts to `/api/newsletter/subscribe` with neighborhoodIds from localStorage.
- **New localStorage keys:** `flaneur-article-reads` (number), `flaneur-email-prompt-dismissed` ('true'), `flaneur-session-count` (number)

### Homepage "Front Door" Experience
- **New visitors:** Full cinematic hero animation plays (logo  tagline  stats  rule  "Read Stories" button). No auto-redirect. User clicks "READ STORIES" to enter.
- **"Read Stories" button:** `HomepageEnterButton` (`src/components/home/HomepageEnterButton.tsx`) - client component, calls `/api/location/detect-and-match` (5s timeout), saves neighborhoods to localStorage + syncs cookie, `router.push('/feed?welcome={city}')`. Graceful fallback to `/feed` on failure. Uses `btn-secondary` styling, `hero-fade-in-delay-4` (1.2s delay).
- **Returning users:** Inline `<script>` in `layout.tsx` syncs localStorage to `flaneur-neighborhoods` cookie on every page load, then redirects from `/` to `/feed` before React hydration (no homepage flash).
- **Revisiting the front door:** Footer FLANEUR logo links to `/discover` (not `/`). ContextSwitcher has "The Front Door" link to `/discover` (house icon).
- **Discover page:** `/discover`  full homepage experience with `HomeSignupEnhanced` (neighborhood chips + "READ STORIES"), no auto-redirect
- **API:** `src/app/api/location/detect-and-match/route.ts`  uses `detectLocationFromIP()` + Haversine sort against all active non-combo neighborhoods
- **WelcomeBanner:** `src/components/feed/WelcomeBanner.tsx`  "Viewing stories near {city}. Customize" with dismiss X. Strips `welcome` param on dismiss. Stores dismissal in localStorage.
- **Translation keys:** `homepage.readStories` (9 languages), `nav.frontDoor` (9 languages)
- **SmartRedirect:** Component still exists (`src/components/home/SmartRedirect.tsx`) but no longer used on homepage. Kept for potential reuse.

### Auth (Pre-Launch)
- **OAuth:** Google login enabled on `/login` and `/signup` pages ("Continue with Google" button + "or" divider above email/password form). Apple login button hidden but fully implemented and ready to re-enable.
- **Current auth:** Email/password only via Supabase Auth. Leaked password protection (HaveIBeenPwned) available on Pro Plan - not yet enabled.
- **OAuth callback routes:** Both `/auth/callback` and `/api/auth/callback` are intact and working
- **Turnstile CAPTCHA:** Cloudflare Turnstile on `/signup` and `/login` pages. Gracefully degrades (no widget shown) when `NEXT_PUBLIC_TURNSTILE_SITE_KEY` is not set. On error, widget resets automatically. Submit button disabled until token received. Dark theme, flexible size. Requires Supabase dashboard CAPTCHA config with the Turnstile secret key.
- **Newsletter subscribe:** `/api/newsletter/subscribe` uses `supabaseAdmin.auth.admin.generateLink({ type: 'magiclink' })` + Resend to send verification email. Bypasses Turnstile CAPTCHA (admin key). Does NOT use `signInWithOtp` (requires CAPTCHA token from client).
- **Custom SMTP:** Auth emails (confirmation, magic link) sent via Resend SMTP for better deliverability. Configured in Supabase Dashboard > Authentication > SMTP Settings.
- **Forgot password:** `/forgot-password` page calls `POST /api/auth/forgot-password` which uses `supabaseAdmin.auth.admin.generateLink({ type: 'recovery' })` + Resend to send branded reset email (bypasses Supabase email system entirely for better deliverability). Reset link routes through `/auth/callback?next=/reset-password` for PKCE code exchange. `/reset-password` page checks session and allows password update, redirects to `/feed` on success.
- **Signup form:** Name, email, password only. No role picker (all users default to `reader`). Rounded corners (`rounded-lg`) on all inputs/buttons matching login page.
- **Login flow:** Server-only path: POST to `/api/auth/signin` (GoTrue REST API with service role key, validates Turnstile server-side, sets cookies via Set-Cookie headers). Client writes `flaneur-auth` + GoTrue localStorage key (zero `navigator.locks` calls), then `window.location.href = '/feed'`. No `signInWithPassword`, no `setSession`. Mobile login: ~1-2s.
- **Login page session check:** Only checks `getSession()` (2s timeout). Does NOT check flaneur-auth (creates redirect loop when cookies expired). If getSession returns null, clears stale flaneur-auth and shows login form.
- **Header auth:** Checks `flaneur-auth` localStorage FIRST (instant, no locks) to show "Account" immediately. Then `getSession()` in background (3s timeout) to upgrade to full User object. Never clears user if getSession returns null (expired JWT is gracefully degraded). `onAuthStateChange` only handles positive session events. Sign-out via full page reload from `/account`.
- **Turnstile server-side:** `/api/auth/signin` validates captcha token via Cloudflare `siteverify` API using `TURNSTILE_SECRET_KEY` env var. Gracefully degrades if Cloudflare unreachable.
- **Middleware:** `getSession()` only (no `getUser()`). `getUser()` was removed because it makes a network call that can hang, and if it returns 401, GoTrue internally clears session cookies via the response's `setAll` callback.
- **Newsletter auto-subscribe:** Both login (`/api/auth/signin`) and signup (`/auth/callback`) auto-insert user into `newsletter_subscribers` table if not already subscribed. Uses admin client (service role), sets `email_verified: true`. Ensures all registered users receive Daily Brief emails.
- **Profile caching:** Signin API fetches profile data (timezone, childcare_mode, prefsToken, theme, language) in parallel with prefs/newsletter. Login page writes to `flaneur-profile` localStorage and restores theme/language to localStorage + DOM. Account page reads cached profile on mount for instant rendering.
- **Preference persistence:** Theme and language preferences synced to `profiles.preferred_theme`/`preferred_language` via fire-and-forget `POST /api/preferences`. `PreferencesSync` component in layout.tsx restores preferences from `flaneur-profile` cache on first authenticated visit when localStorage doesn't have them (new device, OAuth login). Runs once per session via `flaneur-prefs-synced` sessionStorage guard.
- **Sign-out:** `/account` page calls `signOut()` + `POST /api/auth/signout` + `window.location.href = '/'` (full reload clears all state).

### Language Translation (Batch Pre-Translation)
- **Approach:** Batch pre-translate articles and briefs via Gemini Flash cron. UI strings via client-side dictionary.
- **Languages:** English (default), Swedish (sv), French (fr), German (de), Spanish (es), Portuguese (pt), Italian (it), Simplified Chinese (zh), Japanese (ja)
- **DB tables:** `article_translations` (article_id, language_code, headline, body, preview_text), `brief_translations` (brief_id, language_code, content, enriched_content). RLS: public read, service_role write.
- **Hook:** `useLanguage()` (`src/hooks/useLanguage.ts`) - language state, browser detection via `navigator.languages`, localStorage `flaneur-language`
- **Provider:** `LanguageProvider` (`src/components/providers/LanguageProvider.tsx`) - React context wrapping useLanguage, added to layout.tsx
- **UI strings:** `src/lib/translations.ts` - ~290 keys per language, `t(key, language)` lookup with English fallback. `useTranslation()` hook wraps context + t().
- **Toggle:** `LanguageToggle` (`src/components/layout/LanguageToggle.tsx`) - greyscale wireframe globe icon. OFF: click auto-detects browser language; if English, opens picker dropdown so user can choose. ON: globe + amber badge ("SV"), click globe = back to English, click badge = picker dropdown.
- **Cron:** `translate-content` (*/15, maxDuration=300, 250s budget). Translates articles/briefs from last 48h. Concurrency 8, exponential backoff on 429. Phase split: 75% articles, 25% briefs. No per-language cap. **Language rotation:** Rotates start language each run (based on quarter-hour offset) so all 8 languages get fair coverage. Logs to `cron_executions`.
- **API:** `GET /api/translations/article?id=...&lang=...`, `GET /api/translations/brief?id=...&lang=...` - 1h cache headers, returns translation or 404.
- **Content integration:** `TranslatedArticleBody` + `TranslatedHeadline` (article pages), `CompactArticleCard` (feed headlines/previews), `NeighborhoodBrief` (brief content) - all fetch translations client-side, fall back to English.
- **UI chrome:** `t()` wired into Header, Footer, MultiFeed, FeedList, BackToTopButton, NeighborhoodHeader, ContextSwitcher, WelcomeBanner, NeighborhoodBrief, search page, About, Legal, Standards, Contact, Careers pages
- **Flash prevention:** Inline script in layout.tsx sets `document.documentElement.lang` from `flaneur-language` localStorage
- **NOT translated:** Email templates (stay English), admin pages, neighborhood/city names (proper nouns), paid ad content (advertiser-supplied), advertise booking page. House ads ARE translated via `houseAd.{type}.headline/body/cta` keys.
- **Translation sync check:** `node scripts/check-translations.mjs` - verifies all languages have the same keys as English. Run after editing English strings.
- **Footer pages:** About (server/client split for Supabase data), Legal (privacy + terms tabs), Standards (server/client for metadata), Contact, Careers (server/client for metadata) - all fully translated via `t()` keys
- **localStorage key:** `flaneur-language` (ISO 639-1 code, absence = English)
- **Translation service:** `src/lib/translation-service.ts` - Gemini Flash wrapper with retry, preserves local language terms and proper nouns

### Enrichment-Gated Brief Publishing
- **Rule:** Brief articles are NEVER created from unenriched (raw Grok) content. Only `enriched_content` from Gemini is used.
- **Email assembler** (`assembler.ts`): `fetchBriefAsStory()` returns `null` if the brief has no `enriched_content`, skipping the brief link in the email rather than linking to sparse content. **Fallback path:** When generate-brief-articles hasn't created an article yet, assembler creates brief_summary articles directly  uses brief's actual `model` value (not hardcoded), sets `enriched_at`/`enrichment_model`, extracts+inserts sources from `enriched_categories`, and uses `selectLibraryImageAsync()` for Unsplash image lookup (async DB query, no cache preload needed).
- **Brief article cron** (`generate-brief-articles`): Already filters `.not('enriched_content', 'is', null)`, and no longer has a raw content fallback. Neighborhood+date dedup keeps only the latest brief per neighborhood per local day using IANA timezone (`toLocaleDateString('en-CA', { timeZone })`) - prevents duplicate articles from concurrent deployments and fixes UTC date mismatch for non-US timezones. Slug date also uses local timezone. `neighborhoods!inner(id, name, city, timezone)` SELECT includes timezone. Uses actual `model` from brief (DB column is `model`, NOT `ai_model`). Uses `enrichment_model` from brief for enrichment tracking.
- **Effect:** If enrichment hasn't run yet when the email sends, the email will include regular articles but skip the brief link. The brief article gets created on the next cron cycle after enrichment completes.

### Look Ahead Articles (Forward-Looking Events)
- **Cron:** `generate-look-ahead` (`0 0-7 * * *`, maxDuration=300, 270s budget) - runs hourly midnight-7 AM UTC (8 runs), publishes for 7 AM local same day. Per-neighborhood local date computation via `getLocalPublishDate(timezone)`: `toLocaleDateString('en-CA', { timeZone })` for YYYY-MM-DD, `published_at` set to 7 AM local converted to UTC. Grok receives local date (not UTC tomorrow). Dedup queries a broad time window around all neighborhoods' publishAtUtc values and compares per-neighborhood within 2h tolerance (avoids UTC calendar date mismatch for UTC+11..+13 timezones where 7AM local falls on the previous UTC day).
- **Priority:** Neighborhoods sorted by delivery urgency - those whose 7 AM local comes soonest (APAC/East) are processed first
- **Scope:** Fetches `is_active=true` neighborhoods (same as Daily Brief cron - combos are `is_active=true`, components are `is_active=false` so naturally excluded). Filtered to only neighborhoods with active subscribers via `getActiveNeighborhoodIds()`. For combo neighborhoods, `getComboInfo()` expands to component names for Grok search (e.g., "FiDi, Tribeca Core, Lower East Side"). Article stored under combo ID.
- **Grok function:** `generateLookAhead()` in `grok.ts` - forward-looking search framed as "tomorrow morning" (since cron runs evening before). Explicit date context so Grok knows publication date. Returns `LookAheadResult` extending `NeighborhoodBrief` with `structuredEvents: StructuredEvent[]` parsed from `EVENTS_JSON:` section in Grok response.
- **Structured event listing:** `src/lib/look-ahead-events.ts` - `StructuredEvent` interface (date, day_label, time, name, category, location, address, price), `formatEventListing()` groups by date, deduplicates recurring events with "(also on Sun, Mon)" suffix, strips postcodes/city from addresses via `cleanAddress()`, sorts chronologically. Output format: `[[Event Listing]]\n\n[[Today, Sat Feb 21]]\n\nEvent name; Category, Time; Venue, Address.\n\n---`. Cron prepends formatted listing to Gemini-enriched prose body. `isEventLine()` exported for render detection (2+ semicolons). `isPlaceholder()` exported - filters "Not Listed", "TBD", "TBA", "N/A", "Unknown", "Not Available", "None" at both source (`formatEventLine()`) and render time. `ArticleBody.tsx` extracts `[[Event Listing]]...---` block and renders via interactive `EventListingBlock` component with three filter dimensions (day pills, time-of-day chips morning/afternoon/evening/all-day, category chips with +N more toggle), Google Search hyperlinked event names with dotted-underline academic styling, two-line layout (name + category badge, then time/venue/address/price with middot separators), locale-aware AM/PM for US via `formatTime(timeStr, country)`, and "No events match" empty state with "Clear filters" link. When `articleType === 'look_ahead'` and event listing exists, prose body is skipped entirely (redundant restatement of same events). `country` prop threaded through `ArticleBody` -> `TranslatedArticleBody` -> `[slug]/page.tsx`. `LookAheadCard.tsx` has matching compact rendering in expanded view. Teaser extraction skips event listing, only uses prose body. Fallback: if EVENTS_JSON missing/malformed, `structuredEvents = []`, article works prose-only.
- **Tourist trap filter:** Three layers: (1) Grok prompt excludes permanent shows (Mamma Mia, Lion King, Phantom, Wicked), guided tours, food tours, food hall tours, hop-on-hop-off, segway tours, pub crawls, escape rooms, and any activity primarily marketed to tourists; (2) Gemini enrichment `lookAheadStyle` has matching filter; (3) `isTouristActivity()` in `look-ahead-events.ts` catches anything that slips through via regex on event name/category. Only include tourist attractions if something genuinely unusual is happening (closing, reopening, major cast change, anniversary milestone).
- **Gallery/museum filter:** Three-layer filter (Grok prompt, Gemini enrichment, Gemini Search) prevents galleries/museums from being listed just because they're open during normal hours. Only include when there's a specific time-limited occasion: opening reception (with evening time like 6-8 PM), closing day, artist talk, new exhibition premiere, members-only preview, special ticketed event. The test: "would a local specifically plan to visit on THIS day vs any other day?" If no, exclude it.
- **Headline date rule:** Headline must reference something happening today or the very next day with events. Never headline an event 2+ days away when there are things happening sooner.
- **No repetition rule:** Both Grok prompt and Gemini `lookAheadStyle` prohibit repeating the same venue/restaurant/event across multiple day sections. If a venue is open every day, mention it once on the most relevant day. Skip days with no unique events rather than padding with repeats. Quality over quantity.
- **Banned passive language:** Both `grok.ts` (look-ahead system prompt) and `brief-enricher-gemini.ts` (`dailyBriefStyle` and `lookAheadStyle`) ban "Quiet Week/Friday/Day", "Slow", "Calm", "Winding Down", "Not Much Going On", "Nothing Major" in both headlines AND body text via ENERGY RULES. Always lead with what IS happening.
- **Enrichment:** `articleType: 'look_ahead'` in `brief-enricher-gemini.ts` - no greeting/sign-off, organized by individual day headers using `[[Day, Weekday Month Date]]` format (e.g., `[[Today, Wednesday February 18]]`, `[[Thursday, February 19]]`). Skip days with no events. Rendered as `<h3>` section headers by ArticleBody.tsx for scannability. `briefGeneratedAt` set to tomorrow 7 AM so Gemini CURRENT TIME context matches reader's perspective. Uses Flash exclusively (10K RPD, no Pro budget pressure).
- **Headline format:** `LOOK AHEAD: {headline}` (no neighborhood name prefix). Headline prefers Gemini's `subjectTeaser` via `toHeadlineCase()` (same punchy 1-4 word information-gap style as Daily Brief), falls back to Grok's raw headline. `cleanArticleHeadline()` strips the `LOOK AHEAD:` prefix for feed/email display. Article page shows full "LOOK AHEAD:" headline.
- **Article:** `article_type: 'look_ahead'`, `category_label: '{Name} Look Ahead'`, deterministic slug `{id}-look-ahead-{tomorrowDate}-{headline}`, `published_at` set to tomorrow 7 AM UTC, concurrency 5
- **Dedup:** Queries broad time window around all neighborhoods' `publishAtUtc` values, compares per-neighborhood within 2h tolerance (not calendar date range, which fails for UTC+11..+13)
- **API:** `GET /api/briefs/look-ahead?neighborhoodId=xxx` - returns most recent Look Ahead article URL (last 48h). Articles now stored under combo IDs directly. API still expands combo neighborhoods via `combo_neighborhoods` table for backward compatibility with any existing component-stored articles.
- **Feed link:** `LookAheadCard` (`src/components/feed/LookAheadCard.tsx`) - simple self-fetching link below daily brief. Fetches URL from Look Ahead API, renders "What's Coming Up in {name}" link (translated via `feed.lookAheadCta`). Returns null if no Look Ahead article exists. Wired into single-feed `page.tsx` and `MultiFeed.tsx`.
- **Discovery CTAs:** Look Ahead link in `BriefDiscoveryFooter` on article pages. Removed from `NeighborhoodBrief` expanded view (redundant since LookAheadCard itself now expands with discovery CTAs).
- **Email:** Look Ahead URL fetched in `assembler.ts` (`fetchLookAheadUrl()`), passed via `DailyBriefContent.lookAheadUrl`. Rendered in `DailyBriefTemplate` (after stories, before satellites) and `SundayEditionTemplate` (after THE NEXT FEW DAYS section). Link text: "Read the Look Ahead (next 7 days) for {name}". Both `fetchLookAheadAsStory()` and `fetchLookAheadUrl()` accept `isCombo` param  for combo neighborhoods, `expandNeighborhoodIds()` queries `combo_neighborhoods` table to include component IDs in the article lookup (fixes Tribeca, Ostermalm, Hamptons Overview missing Look Ahead articles stored under component IDs).
- **Article pages:** `BriefDiscoveryFooter` rendered with `variant="look_ahead"` on Look Ahead pages (shows "Read today's Daily Brief", hides self-referential Look Ahead link, shows add-to-neighborhoods + email capture), `variant="sunday"` on Sunday Edition pages (discovery links only), default `variant="daily"` on daily brief pages. Uses `article.neighborhood_id` from DB (not `buildNeighborhoodId()`) to avoid mismatches for non-standard country slugs.
- **Cost:** ~$0.48/day (~50-80 neighborhoods x $0.006 per Grok+Flash call)
- **Translation keys:** `feed.lookAhead`, `feed.lookAheadCta` in all 9 languages. Article body translation handled by existing `translate-content` cron.

### Mobile UX Overhaul
- **Navigation wayfinding:** Logo links to `/feed` (not `/`). "Stories" link in both desktop and mobile nav for all users. "Dashboard" gated behind admin. Default entry point changed from `/login` to `/signup`.
- **Homepage hero:** FLANEUR + tagline wrapped in `<Link href="/feed">` on both `/` (homepage) and `/discover` as manual fallback for returning users.
- **Mobile menu:** "Edit selections" renamed to "Edit Neighborhoods" with `text-amber-500/80` accent. "Stories" link appears for all users (auth + unauth). Padding tightened to `py-3`.
- **Back-to-top button:** Bottom-right FAB on mobile (`fixed bottom-6 right-4`), top-center on desktop. Text label hidden on mobile (`hidden md:inline`).
- **Masthead padding:** `pt-2 md:pt-6` (tighter on mobile, preserved on desktop).
- **Neighborhood nav (MultiFeed):** Mobile (<768px): dropdown selector (`bg-[#121212] border-white/10 rounded-lg`) showing active neighborhood name + city or "All Stories", with `max-h-[60vh]` scrollable list (amber dot for primary, checkmark for active, PRIMARY badge). Click-outside-to-close. "Explore other neighborhoods" link at bottom opens selector modal. Manage button beside dropdown; ViewToggle moved down to just above feed (`md:hidden flex justify-end`). "Make {name} my primary" link (`md:hidden`) appears below dropdown when a non-primary pill is selected - reorders localStorage, syncs cookie, calls sync-primary API, then `router.refresh()`. Desktop (>=768px): unchanged pill bar with drag-to-reorder, scroll arrows, fade indicators, manage + ViewToggle in pill row. Both share `activeFilter` state.
- **Guide/Map/History:** Hidden on mobile (`hidden md:flex`), replaced with `...` overflow dropdown (`md:hidden`) containing Guide/Map/History as vertical items.
- **Daily brief styling:** `border-l-2 border-amber-500/40` on brief container to distinguish from ads.
- **Brief ordering (single view):** Brief moved from before `<NeighborhoodFeed>` to `dailyBrief` prop (renders after header, not before neighborhood name).
- **Compact card mobile layout:** On mobile (`md:hidden`), metadata + headline render full-width above image. Image sits left with blurb to its right. Desktop unchanged (single flex row).
- **Gallery card mobile layout:** On mobile, metadata + headline render above the image (not overlaid). Headline wraps to max 2 lines via `line-clamp-2`. Desktop keeps gradient overlay on image. Gallery spacing: `space-y-6` mobile, `space-y-4` desktop.
- **Metadata no-wrap:** `CompactArticleCard` metadata row gets `overflow-hidden whitespace-nowrap`. Category label strips redundant neighborhood prefix via regex, truncates at 120px.
- **Neighborhood selector:** Search input no auto-focus on mobile (desktop only via `window.innerWidth >= 768`). Attempts geolocation on open for default nearest sort. Tapping a selected neighborhood expands an inline action row (`expandedId` state) with Set Primary / Go to stories / Remove buttons instead of instantly deselecting - `expandedId` resets on search/tab change. `makePrimary` calls sync-primary API for DB sync. Mobile keyboard fix: `isSearchActive` state hides selected pills and sort buttons when focused + typing to maximize result space (200ms blur delay so clicks register). "Go to Stories >" escape link in modal header.
- **Auth flow:** `emailRedirectTo: window.location.origin/auth/callback` prevents localhost redirect. "Check spam" hint on confirmation screen.
- **AI badge on feed images:** `ArticleCard.tsx` skips the AI badge when `image_url` contains `unsplash.com` since those are real photos, not AI-generated.
- **Ad grace period:** `useNewUserGracePeriod` hook (`src/hooks/useNewUserGracePeriod.ts`) checks `flaneur-first-visit` localStorage timestamp. `FeedList` filters out ads and email prompts during first 5 days.
- **New localStorage key:** `flaneur-first-visit` (timestamp, set on first visit)

### Tracked Referral System
- **Invite page:** `/invite` - dual-mode page. **Inviter mode** (existing user, no `?ref=` param): "Share Flaneur" heading, personalized invite link in readonly input, "Copy Link" + "Share" buttons (native share on mobile), referral stats (clicks/friends joined) if > 0. **Invitee mode** (new visitor or `?ref=` param): streamlined hero with email input, auto-detects location on submit, subscribes, redirects to `/feed?welcome={city}`. No `SmartRedirect` (visitors must see the page). Detection: `flaneur-newsletter-subscribed` localStorage OR `flaneur-neighborhood-preferences` localStorage OR active auth session (via `getSession()`), AND no `?ref=` param.
- **Referral link:** `/invite?ref=CODE` - hero shows "A friend invited you to" above FLANEUR. Code stored in `sessionStorage` (`flaneur-referral-code`).
- **Referral codes:** 8-char alphanumeric (no ambiguous chars), lazy-generated on first access via `generate_referral_code()` Postgres function. Unique across `profiles.referral_code` and `newsletter_subscribers.referral_code`.
- **API endpoints:**
  - `GET /api/referral/code` - get or generate code (session auth or email+token)
  - `POST /api/referral/track` - record click (fire-and-forget, IP hash dedup within 24h)
  - `POST /api/referral/convert` - record conversion (fire-and-forget, self-referral prevention)
  - `GET /api/referral/stats` - return `{ code, clicks, conversions }` for share widget
- **Conversion flow:** Subscribe on invite page -> `POST /api/newsletter/subscribe` -> `POST /api/referral/convert` (fire-and-forget). Updates existing click row to `converted` status, or creates direct conversion if no click row exists.
- **Share surfaces:**
  - Email footer: "Share Flaneur" link (between "Manage preferences" and "Unsubscribe") in Daily Brief (`Footer.tsx`) and Sunday Edition (inline footer). Only shown when recipient has a referral code.
  - ContextSwitcher: "Invite a Friend" item at bottom of dropdown (via `ShareWidget` compact mode). Only shown if `flaneur-newsletter-subscribed` is set.
  - Invite page: `/invite` shows share UX with invite link + copy/share buttons for subscribed users (inviter mode)
  - `ShareWidget` (`src/components/referral/ShareWidget.tsx`): Fetches code from `/api/referral/code`, caches in localStorage (`flaneur-referral-code`). Uses `navigator.share()` on mobile, clipboard copy on desktop.
- **Scheduler integration:** `src/lib/email/scheduler.ts` fetches `referral_code` from both `profiles` and `newsletter_subscribers`, lazy-generates if null. Passed via `EmailRecipient.referralCode` to templates.
- **Database:** `referrals` table (referral_code, referrer_type/id, referred_email/type/id, status clicked/converted, ip_hash, timestamps). RLS: service_role only. Unique index on `(referral_code, referred_email) WHERE status = 'converted'`.
- **localStorage keys:** `flaneur-referral-code` (user's own code, cached by ShareWidget)
- **sessionStorage keys:** `flaneur-referral-code` (incoming referral code from `?ref=` param, consumed on conversion)

### Suggest a Neighborhood
- **House ad:** `house_ads` where `type = 'suggest_neighborhood'`, headline "Suggest a Neighborhood", click_url `#suggest` (handled inline, not navigated)
- **Shared form:** `src/components/NeighborhoodSuggestionForm.tsx` - client component with `compact` (house ad inline) and `full` (contact page) variants. Suggestion text + optional email + submit.
- **FallbackAd integration:** `HouseAdDisplay` handles `suggest_neighborhood` type - renders "Suggest" button that toggles inline form (not a link). Both card and story_open variants.
- **Contact page:** `/contact` includes "Suggest a Neighborhood" section with full-variant form
- **API endpoint:** `POST /api/suggestions/neighborhood` - validates (3-200 chars), SHA-256 IP hash, rate limit 5/hour per IP, detects city/country from Vercel headers, inserts to `neighborhood_suggestions` table
- **Email notification:** `notifyNeighborhoodSuggestion()` in `email.ts` sends to `contact@readflaneur.com`
- **Neighborhood selector modal:** `NeighborhoodSelectorModal.tsx` "Suggest a Destination" wired to API endpoint (was direct Supabase insert that silently failed due to RLS). Optional email field added. Both placements: bottom of city list + empty search state.
- **Admin page:** `/admin/suggestions` - stats row, filter tabs (all/new/reviewed/added/dismissed), table with inline notes editing and status actions
- **Admin API:** `GET/PATCH /api/admin/suggestions` - admin role auth, service role DB access

### Community Neighborhoods (User-Created)
- **Limit:** 2 per authenticated user
- **Create endpoint:** `POST /api/neighborhoods/create` (maxDuration=300) - auth, limit check, Gemini Flash AI validation (verifies real place where people live - neighborhoods, towns, villages, municipalities, cities - rejects countries/states/continents/fictional, normalizes name/city/country/region/timezone/coordinates), duplicate detection (exact ID + 500m Haversine proximity), insert, newsletter_subscribers sync, fast pipeline, instant resend
- **Pipeline:** Fast initial content via Gemini Flash (~15-20s total) instead of Grok (~40-60s). Image library runs in parallel with fact-gathering via `Promise.allSettled`. Full Grok pipeline runs overnight via `sync-neighborhood-briefs` cron for quality upgrade. Steps:
  1. Gemini Flash Search (`searchNeighborhoodFacts()`) + Unsplash image library (`generateNeighborhoodLibrary()`) in parallel (~5-10s)
  2. Brief creation from Gemini Search facts
  3. Gemini enrichment (`enrichBriefWithGemini()`) for proper greeting, structured sections, hyperlinks, subject teaser headline (~5-10s). If Gemini fails (quota exhaustion, API error), Claude Sonnet fallback via `enrichWithClaude()` produces same output format (local-language greeting, `[[section headers]]`, prose paragraphs, TEASER extraction).
  4. Article creation from enriched content (with `enriched_at` set so enrich-briefs Phase 2 skips it)
  5. If creator has non-English `preferred_language` in profiles, translates both brief and article via Gemini Flash in parallel (~2-3s). Inserts into `brief_translations` and `article_translations` so user sees content in their language immediately instead of waiting for translate-content cron.
- **Newsletter sync:** Auto-adds new neighborhood to creator's `newsletter_subscribers.neighborhood_ids` so email crons (sync-neighborhood-briefs, send-daily-brief) discover it
- **Count endpoint:** `GET /api/neighborhoods/my-community-count` - returns `{ count }` for limit UI
- **DB columns:** `neighborhoods.is_community` (boolean), `neighborhoods.created_by` (UUID), `neighborhoods.community_status` ('active'|'removed')
- **Region:** All community neighborhoods use `region: 'community'`
- **ID format:** `generateCommunityId(city, name)` - deterministic slug (e.g., `paris-montmartre`)
- **Shared utilities:** `src/lib/community-pipeline.ts` - `generateCommunityId()`, `generateBriefArticleSlug()`, `generatePreviewText()`
- **Neighborhood selector:** "All Neighborhoods" | "Community" tab toggle. Community tab has create form (text input + button with validating/generating status states), count display, community neighborhood list grouped by city. "Created by you" badge in `text-accent` for neighborhoods where `created_by === userId`, "Community" badge in `text-fg-subtle` for others. Prominent create CTA: when search has no results in All tab, sort buttons and selected pills hide, amber-bordered card appears with "Create {query}" full-width button that switches to Community tab with query pre-filled.
- **Modal tab param:** `openModal('community')` opens directly to Community tab (used by house ad)
- **House ad:** `community_neighborhood` type in `house_ads` - "Create Your Own Neighborhood" with "Get Started" button. Opens modal to Community tab. Hidden via `flaneur-has-community-neighborhood` localStorage once user has created one.
- **Post-creation flow:** On success, modal closes and navigates to `/{city}/{neighborhood}?created=true`. `NewNeighborhoodCelebration` component (`src/components/feed/NewNeighborhoodCelebration.tsx`) renders countdown timer with elapsed seconds, polls Supabase every 3s for first published article. On article found: balloon emoji celebration animation (24 emojis rising from bottom, `@keyframes balloon` in globals.css) for 4s, then `router.replace()` strips `?created=true` param and `router.refresh()` loads the feed. Safety timeout at 90s shows page anyway. Wired into `[city]/[neighborhood]/page.tsx` - renders when `created=true` and no articles exist.
- **Admin:** `/admin/community-neighborhoods` page + `GET/PATCH /api/admin/community-neighborhoods` - list all, remove/restore (toggles `community_status` + `is_active`)
- **Neighborhoods API:** Filters out `community_status = 'removed'` neighborhoods. Hides `region = 'test'` neighborhoods from non-admin users (admin check via session + profile role).
- **localStorage keys:** `flaneur-has-community-neighborhood` ('true' after first creation)
- **Executive status application:** When users reach 2-neighborhood limit, "apply for executive status here" link reveals inline textarea + submit. API: `POST /api/neighborhoods/apply-executive` inserts into `executive_applications` table (pending status). Duplicate prevention: one pending application per user.
- **Self-delete:** Creator can delete community neighborhood within 24h if 0 other followers. Trash icon with confirm dialog. API: `POST /api/neighborhoods/delete-community` (soft-delete: sets `community_status = 'removed'`, `is_active = false`). `GET` returns eligibility map. DB: `neighborhoods.created_at` column (null for existing = not eligible).
- **Report:** Users can report others' community neighborhoods. Inline "Report" link with reason input. API: `POST /api/neighborhoods/report`. DB: `neighborhood_reports` table (unique per neighborhood+reporter). "Reported" label replaces link after submission.
- **Celebration empty state:** Community neighborhoods with 0 articles and `?created=true` show `NewNeighborhoodCelebration` with countdown timer, pulsing dot, "Building your {name} edition" message, and balloon celebration when content arrives. Without `?created=true`, shows "Initializing Coverage Protocol" with pulsing dot. Feed page queries `is_community` from neighborhoods table.
- **1-week reminder email:** `send-community-reminder` cron (`0 9 * * *`) sends branded email to creators 7 days after creation. Links to most recent daily brief article + neighborhood feed page. Uses 24h time-window dedup (7-8 days ago) so each neighborhood is matched exactly once with no migration needed. Skips neighborhoods with no published articles or creators with no email. Logged to `cron_executions`.

### Dynamic House Ads ("Check Out a New Neighborhood")
- **DB record:** `house_ads` where `type = 'app_download'` updated: headline "Check Out a New Neighborhood", body "See what's happening today in a nearby neighborhood.", click_url `/discover` (static fallback)
- **Shared utility:** `src/lib/discover-neighborhood.ts` - `findDiscoveryBrief(supabase, subscribedIds, referenceNeighborhoodId, options?)` returns `{ url, neighborhoodName }` or null. `DiscoveryOptions`: `mode` (`'nearby'` default, or `'random'`), `excludeCity` (for random diversity).
- **Logic:** Fetches active non-combo neighborhoods, filters out subscribed. Nearby mode: sorts by Haversine distance. Random mode: Fisher-Yates shuffle, excludes specified city. Tries top 10 for a published Daily Brief article.
- **Email integration:** `src/lib/email/ads.ts` - `getHouseAd()` accepts `subscribedIds`/`primaryNeighborhoodId`, resolves dynamic URL for `app_download` type via `findDiscoveryBrief()`
- **Web integration:** `HouseAdDisplay` in `FallbackAd.tsx` - `useEffect` reads localStorage prefs, fetches `/api/discover-neighborhood?subscribedIds=...&referenceId=...`, updates click URL from `/discover` to resolved brief URL
- **API endpoint:** `GET /api/discover-neighborhood` - public, no auth, accepts `mode` and `excludeCity` query params, calls `findDiscoveryBrief()`, returns `{ url, neighborhoodName }` or `{ url: "/discover" }` fallback
- **Brief card CTAs:** `NeighborhoodBrief.tsx` - when expanded, shows discovery links below source attribution: "Read yesterday's [Name] Daily Brief", "Read today's nearby [Name] Daily Brief" (nearby mode), and "Take me somewhere new" (random mode, excludes current city). Lazy-fetched on first expand (three parallel API calls), cached in component state.
- **Brief article CTAs:** `BriefDiscoveryFooter.tsx` - on daily brief article pages, unified "Keep reading" section right after source attribution: yesterday's brief, add to neighborhoods (if not subscribed), nearby brief, "take me somewhere new", and inline email capture ("Get them emailed 7am daily"). Current neighborhood excluded from discovery candidates.
- **Yesterday's brief API:** `GET /api/briefs/yesterday?neighborhoodId=...&excludeSlug=...` - returns previous brief article URL for a neighborhood.

### Add to Collection CTA (Article Pages)
- **Component:** `AddToCollectionCTA` (private, inline in `FallbackAd.tsx`) - shows "Add {neighborhoodName} to Your Collection" on article bottom ad slot when the neighborhood is not in user's collection
- **Props:** `articleNeighborhoodId` and `articleNeighborhoodName` passed from article page to bottom `FallbackAd` only
- **Logic:** `useEffect` checks `flaneur-neighborhood-preferences` localStorage. If neighborhood already present, returns null (normal fallback renders). On click: adds to localStorage array, fires `POST /api/neighborhoods/add` (fire-and-forget DB sync), shows success state.
- **API endpoint:** `POST /api/neighborhoods/add` - accepts `{ neighborhoodId }`, uses `getSession()` auth. Authenticated: inserts into `user_neighborhood_preferences` (with next sort_order). Anonymous: returns success (localStorage-only).
- **Placement:** Bottom ad slot only on article pages (`position="bottom"`). Top slot remains normal house ad/fallback.

## Key Patterns

### Feed Neighborhood Cookie
- **Cookie:** `flaneur-neighborhoods` - comma-separated neighborhood IDs, `SameSite=Strict`, `path=/`, 1-year `max-age`
- **Source of truth:** DB `user_neighborhood_preferences` for logged-in users (synced to localStorage on mount + tab focus via `useNeighborhoodPreferences`). `flaneur-neighborhood-preferences` localStorage for anonymous users. Cookie is a sync copy for server-side reading.
- **Server reading:** `feed/page.tsx` reads `cookies().get('flaneur-neighborhoods')` from `next/headers` to pre-fetch articles, briefs, weather, ads server-side.
- **Sync points:** Cookie is synced from localStorage at every navigation to `/feed` - inline `<script>` in `layout.tsx` (pre-hydration), plus explicit `document.cookie` set before `router.push('/feed')` or `router.refresh()` in all client components that modify neighborhoods.
- **Utility:** `src/lib/neighborhood-cookie.ts` - `NEIGHBORHOODS_COOKIE` constant, `syncNeighborhoodCookie()` client function
- **Why cookie not URL:** Prevents long URLs with 25+ neighborhoods, prevents abuse (anyone could construct a custom feed URL), `SameSite=Strict` keeps data browser-local
- **Clearing:** `NeighborhoodSelectorModal.clearAll()` sets cookie to empty (`max-age=0`)

### Primary Neighborhood Sync
- **Endpoint:** `POST /api/location/sync-primary-neighborhood` - syncs primary neighborhood change to DB for email scheduler
- **Called from:** `useNeighborhoodPreferences.setPrimary()` (fire-and-forget, covers ContextSwitcher, modal, drag-reorder)
- **Logic:** Uses `getSession()` (not `getUser()`), looks up neighborhood city, updates `profiles.primary_city`/`primary_timezone`/`primary_neighborhood_id`, triggers instant resend on any primary change (same city or different)
- **DB columns:** `profiles.primary_city` (text), `profiles.primary_timezone` (text), `profiles.primary_neighborhood_id` (FK to neighborhoods.id)
- **Email scheduler:** Uses `primary_neighborhood_id` directly if set, falls back to first neighborhood matching `primary_city` for backwards compatibility
- **Anonymous users:** Silent no-op (returns success)

### Cron Jobs
- All in `src/app/api/cron/[job-name]/route.ts`
- Auth: `x-vercel-cron` header or `CRON_SECRET`
- **MUST** log to `cron_executions` table
- Use `maxDuration = 300` for long-running jobs
- Use time budgets to ensure logging completes in `try/finally`

### Daily Content Health Monitor
- **Cron:** `check-daily-health` (`0 10 * * *`, maxDuration=60)
- **9 checks:** Brief coverage, content quality (enrichment + paragraph count), hyperlinks in enriched content, HTML artifacts in article bodies, translation coverage, email delivery, story images, editorial sources (brief_summary/look_ahead/weekly_recap articles shouldn't have source rows), URL-encoded text (`%20`/`%2C`/etc. in article bodies)
- **Output:** Creates `cron_issues` for auto-fixable problems (picked up by `monitor-and-fix` on next 30-min cycle), emails admin summary report with pass/warn/fail per check
- **Issue types:** `missing_sunday_edition` (manual), `unenriched_brief` (auto-fix via re-enrichment), `thin_brief` (manual), `missing_hyperlinks` (auto-fix via re-enrichment), `html_artifact` (manual), `editorial_sources` (auto-fix: delete inappropriate source rows), `url_encoded_text` (auto-fix: decodeURIComponent on body)
- **Auto-fixer (`monitor-and-fix`):** Runs every 30 min. `getRetryableIssues()` fetches up to 50 open issues from the last 7 days, newest first. Route dispatches all fixable types through `attemptFix()` with per-type rate limits: images (5/run), thin content (10/run), emails (10/run), enrichment i.e. unenriched_brief + missing_hyperlinks (5/run, 2s delay), DB-only fixes like missing_sources/url_encoded_text (no limit). Non-auto-fixable types (job_failure, html_artifact, thin_brief) are skipped.
- **Files:** `src/lib/cron-monitor/health-checks.ts` (check functions), `src/lib/cron-monitor/auto-fixer.ts` (auto-fix handlers), `src/lib/cron-monitor/health-report-email.ts` (email template), `src/app/api/cron/check-daily-health/route.ts` (cron endpoint), `src/app/api/cron/monitor-and-fix/route.ts` (auto-fix cron), `src/lib/cron-monitor/issue-detector.ts` (issue detection + retryable query), `src/lib/cron-monitor/types.ts` (FIX_CONFIG constants)

### Daily Writing Quality Review
- **Cron:** `review-writing-quality` (`0 11 * * *`, maxDuration=120)
- **Sampling:** 3 random active-subscriber neighborhoods for daily briefs + 3 different ones for look-ahead articles, 7 most recent items per neighborhood (enriched_content from neighborhood_briefs, body_text from articles where article_type=look_ahead)
- **Analysis:** Shared editorial prompt sent to Gemini Pro 2.5 and Claude Sonnet in parallel via `Promise.allSettled()`. Benchmarks against FT HTSI, Morning Brew, Monocle, Puck, Airmail, Vanity Fair. Sections: Grok search query recommendations, writing persona/style recommendations, engagement/shareability, biggest single improvement.
- **Output:** HTML email to `ADMIN_EMAIL` (fallback `contact@readflaneur.com`) with both analyses. Full analyses stored in `cron_executions.response_data` for historical reference.
- **Cost:** ~$0.27/day (~$8.10/month). Recommendations-only - no automatic prompt/persona changes.
- **File:** `src/app/api/cron/review-writing-quality/route.ts`

### Article Deduplication (sync-news)
- **RSS articles:** Deterministic `generateSlug()` (djb2 hash, no timestamp) + source URL check in `editor_notes`
- **Grok articles:** Headline similarity check (first 40 chars, same neighborhood, last 24h) + deterministic slug
- **Fashion week:** Slug includes day number; prompt requires "Day N" in headline with day-specific angle

### Gemini Search - Dual-Source Fact-Gathering
- **File:** `src/lib/gemini-search.ts` - parallel second fact-gatherer alongside Grok using Gemini Flash with Google Search grounding
- **Architecture:** `Promise.allSettled([grokCall, geminiCall])` - zero latency increase (Gemini Flash ~5-10s finishes before Grok ~25-30s)
- **Model:** `gemini-2.5-flash` with `tools: [{ googleSearch: {} }]`, temperature 0.5. Stays within 10K RPD budget.
- **Retry:** Exponential backoff (2s/5s/15s) on 429/RESOURCE_EXHAUSTED, reused from `brief-enricher-gemini.ts`
- **Daily briefs (`searchNeighborhoodFacts()`):** Targets what Grok misses - official event calendars, local newspaper articles, city government announcements, restaurant/retail openings, real estate listings. `recentTopics` param injects last 5 brief headlines to break repetition cycles. Returns raw bullet-point facts.
- **Look Ahead (`searchUpcomingEvents()`):** Targets gallery exhibitions, museum schedules, restaurant openings, concert/theater listings, farmers markets, pop-ups, community board meetings. Returns `StructuredEvent[]` (same type from `look-ahead-events.ts`) + prose text. Multiple search angles per neighborhood.
- **Merging (`mergeContent()`):** If both sources succeed, Gemini facts appended with `\n\nALSO NOTED:\n` label so enrichment step understands supplemental material. If only one succeeds, uses whichever is available.
- **Event dedup (`mergeStructuredEvents()`):** Deduplicates by name similarity (substring match + word overlap > 0.7), keeps entry with more fields, sorts chronologically.
- **Integration points:** `sync-neighborhood-briefs` (daily briefs), `generate-look-ahead` (Look Ahead articles), `weekly-brief-service.ts` (Sunday Edition Horizon events - always-dual, max 5 events up from 3)
- **Anti-repetition:** Gemini prompt explicitly avoids recently covered topics. Targets institutional sources (gallery calendars, official event listings) that Grok's X-heavy search surface misses.
- **Cost:** ~$0.70/day (~$21/month) for ~350 additional Gemini Flash calls
- **Enrichment prompt rules:** ONE STORY PER SECTION (each story gets own header/paragraph), STORY ORDER (recency-first for daily briefs, consequential-first for Sunday Edition, noteworthy-first for Look Ahead)

### Gemini Enrichment (enrich-briefs)
- **Model strategy:** Pro for briefs, Flash for articles. Phase 1 (daily briefs) always uses `gemini-2.5-pro` for highest quality. Phase 2 (RSS articles) always uses `gemini-2.5-flash`. Model split logged in `response_data` (`model_pro_used`/`model_flash_used`).
- **Schedule:** `*/15`, batch size 30, concurrency 4, Phase 1 budget 200s
- **Backoff:** Exponential retry on 429/RESOURCE_EXHAUSTED (2s, 5s, 15s delays)
- **Early termination:** Drains queue if any batch call hits quota
- **Two phases:** Phase 1 = briefs (200s budget, Pro), Phase 2 = RSS articles only (remaining ~80s, Flash). Phase 2 skips `brief_summary` and `look_ahead` articles  they're already enriched by their own pipelines and must not be re-enriched with the wrong style.
- **Greeting:** CRITICAL formatting rule requires "Good morning, {neighborhood}" as the very first line of every daily brief. Reinforced in both style section and formatting rules to ensure Pro compliance.
- **Language:** Prompt requires English output with local language terms sprinkled in naturally (Swedish greetings, French venue names, etc.). Prevents Gemini from writing entirely in the local language when searching local-language sources.
- **Daily framing:** Prompt explicitly states "This is a DAILY update" and prohibits weekly/monthly framing ("another week", "this week's roundup")
- **Link preservation:** Gemini's Google Search grounding naturally includes markdown links in prose. These are preserved in `enriched_content` (not stripped). Render-time components convert them to clickable `<a>` tags.
- **Continuity context:** `fetchContinuityContext()` in cron fetches last 5 enriched briefs (headline + 200-char sentence-truncated excerpt) and last 3 days of non-brief articles (headline + article_type). Injected as `RECENT COVERAGE CONTEXT` block in prompt. Enables natural back-references ("as we noted Tuesday..."). ~300-800 extra tokens per prompt. Optional param (`continuityContext`), backward compatible. Only applies to daily briefs (not weekly recaps). Non-fatal on fetch failure.
- **Subject teaser:** Gemini generates a 1-4 word "information gap" teaser in the enrichment JSON response (`subject_teaser` field). Stored in `neighborhood_briefs.subject_teaser`. Validated: 1-5 words, max 40 chars. Zero extra API calls. **Dual use:** (1) Email subject lines via sender.ts - lowercase format `{teaser}, {neighborhood}` (e.g., "heated school meeting, upper west side"); (2) Article headlines via `generate-brief-articles` and assembler.ts fallback - Title Case via `toHeadlineCase()` (e.g., "Heated School Meeting"). Falls back to Grok-generated headline when null. No circular dependency: email reads from `neighborhood_briefs.subject_teaser` directly, article headline stored separately in `articles.headline`.

### Brief Generation Timezone Handling (sync-neighborhood-briefs)
- **Morning window:** Midnight-7 AM local time (28 chances at `*/15`, survives 6h cron gaps). Starts at midnight to give 7h for full pipeline before 7 AM email.
- **Concurrency:** 3 parallel Grok calls per run (~27-30 briefs per run vs ~9-10 sequential). Each Grok brief takes ~25-30s.
- **Dedup (3 layers):** (1) `UNIQUE(neighborhood_id, brief_date)` DB constraint - absolute guarantee, (2) pre-Grok real-time `brief_date` check before expensive API call, (3) batch filter queries `brief_date` column for yesterday/today/tomorrow (~810 rows, under 1000-row cap). `brief_date DATE NOT NULL` column stores the local date at generation time. All 3 INSERT sites (sync-neighborhood-briefs, neighborhoods/create, auto-fixer) include `brief_date` and handle `23505` unique_violation gracefully.
- **Anti-repetition (separate concern):** Recent headlines fetched via separate 7-day query with `.limit(1000)` for Grok's `recentTopics` param. Not used for dedup.
- **Content sanitization:** Both `grok.ts` and `NeighborhoodBrief.cleanContent()` strip raw Grok search result objects (`{'title': ..., 'url': ...}`) that occasionally leak into brief text
- **Grok citation stripping:** All Grok headline parsing must strip citation markers (`[[1]](url)`, `[1]`, `(1)`) via a 4-pattern regex chain (remove `[[n]](url)`, remove `[n]`, remove `(n)`, collapse double spaces). Applied in `generateNeighborhoodBrief()`, `generateGrokNewsStories()`, and `generateLookAhead()`. Without this, URLs leak into headlines and slugs.

### Image Library (Unsplash Stock Photos)
- **Core:** `src/lib/image-library.ts` - types, `selectLibraryImage()`, `getLibraryReadyIds()`, `checkLibraryStatus()`, module-level LRU cache (1hr TTL) for Unsplash photos
- **Unsplash client:** `src/lib/unsplash.ts` - API client with interleaved dual-query search in `searchAllCategories()`: two parallel searches `"{name} {city}"` (30 results, for city-disambiguation) + `"{name}"` alone (30 results, for iconic/popular shots), interleaved via alternating merge and deduped by photo ID. City-qualified results take odd positions (1,3,5...), name-only take even (2,4,6...) so the 8 assigned categories get a mix of accurate and visually striking photos. Handles ambiguous names (SoHo, Downtown, Midtown) since city-qualified results take priority in the interleave. Falls back to city-only `"{city}"` and city+country `"{city} {country}"` if combined results < 8. Accepts optional `country` param. Throws on rate limit (403/429) so crons can stop early. Triggers download endpoint for attribution tracking (required by Unsplash terms). Cost: 2 API calls per neighborhood (well within 5000/hr budget).
- **Generator:** `src/lib/image-library-generator.ts` - calls `searchAllCategoriesWithAlternates()`, stores results in `image_library_status.unsplash_photos` JSONB + overflow in `unsplash_alternates` JSONB. Fetches `rejected_image_ids` before search to exclude blacklisted photos. ~200ms per neighborhood. Returns `{ photos_found, errors }`.
- **Unsplash CDN URLs:** Hotlinked per Unsplash terms (no downloading/re-hosting). Format: `images.unsplash.com/...&w=1200&q=80&fm=webp`. Already in `next.config.ts` remotePatterns.
- **Categories (8 per neighborhood):** `daily-brief-1/2/3` (rotated by day % 3), `look-ahead-1/2/3` (rotated by day % 3), `sunday-edition` (single), `rss-story` (single). RSS/news/standard articles rotate across full pool (8 category photos + up to 40 alternates = ~48 unique images) using `articleIndex % fullPool.length`. Brief/Look Ahead/Sunday Edition articles use their dedicated category photos.
- **Selection (sync):** `selectLibraryImage(neighborhoodId, articleType, categoryLabel?, libraryReadyIds?, articleIndex?)` - checks Unsplash cache. For RSS/news articles with `articleIndex`, builds combined pool from `cached.photos` + `cached.alternates` for maximum variety. Returns `''` on cache miss. All 273 neighborhoods have Unsplash photos.
- **Selection (async):** `selectLibraryImageAsync(supabase, neighborhoodId, articleType, categoryLabel?, articleIndex?)` - tries sync cache first, then queries DB directly (fetches both `unsplash_photos` and `unsplash_alternates`). Same full-pool logic for RSS/news articles. Returns Unsplash URL or `''`.
- **Cache preload required:** All crons using `selectLibraryImage()` must call `preloadUnsplashCache(supabase)` at startup. The Unsplash photos and alternates live in `image_library_status.unsplash_photos` and `unsplash_alternates` JSONB and are loaded into an in-memory module-level cache (`CacheEntry` = `{ photos, alternates, timestamp }`). Without preloading, `selectLibraryImage()` returns `''`. Applies to 7 crons: generate-brief-articles, generate-look-ahead, generate-guide-digests, sync-news, sync-weekly-brief, generate-community-news, retry-missing-images.
- **Attribution:** Article pages (`[slug]/page.tsx`) display "Photo by [Name] on Unsplash" with UTM-tagged links below Unsplash images. Credit resolved from `image_library_status.unsplash_photos` JSONB.
- **Admin endpoint:** `POST /api/admin/generate-image-library` - single (`neighborhoodId`) or batch mode. `GET` returns status counts.
- **Automated refresh:** `refresh-image-library` cron (`0 */4 * * *`, every 4 hours). Stops on rate limit. Triggers on: no Unsplash photos, empty alternates (backfill), or different season (quarterly variety). Emails admin on completion.
- **Rate limits:** Production: 5000/hr (all 273 in one run).
- **Cost:** $0 (Unsplash API is free)
- **DB:** `image_library_status` table - `unsplash_photos` JSONB column stores `{ "category": { id, url, photographer, photographer_url, download_location } }` per neighborhood. `unsplash_alternates` JSONB stores overflow photos (up to 40) for swap pool. `rejected_image_ids` TEXT[] blacklists photo IDs that received negative feedback. Legacy `images_generated` column kept for backward compat.
- **Fallback chain:** Unsplash cache  empty string (retry-missing-images fills later). Async path: Unsplash cache  DB lookup  empty string. Legacy Supabase Storage URLs eliminated (files don't exist).
- **generate-image endpoint:** Library lookup + sensitive headline check + SVG placeholder only (no more Gemini Image generation)
- **retry-missing-images cron:** Library-only (no generate-image fallback). Skips HEAD check for Unsplash CDN URLs. Phase 3: calls `get_negative_images(-2)` RPC to find Unsplash URLs with score <= -2, resolves neighborhood via articles table, calls `swapNegativeImage()` to replace bad photo with alternate.
- **Negative image swap:** `swapNegativeImage(supabase, neighborhoodId, badImageUrl)` in `image-library.ts` - finds category holding bad URL, swaps in first alternate, bulk-updates all articles, blacklists old photo ID in `rejected_image_ids`, invalidates cache, triggers Unsplash download attribution. Returns `{ oldUrl, newUrl, articlesUpdated, newPhotographer }` or null.
- **RPC:** `get_negative_images(threshold)` - returns `{image_url, score}` for Unsplash URLs with aggregate feedback score <= threshold. Index on `image_feedback(image_url)` for efficient aggregation.
- **Cron category images:** `src/lib/cron-images.ts` - `getCronImage(category, supabase, { neighborhoodId })` prefers Unsplash library photos when `neighborhoodId` is provided (DB lookup for `image_library_status.unsplash_photos`, returns `rss-story` category URL). Falls back to AI cached images in Supabase Storage `cron-cache/` only when no Unsplash photos exist. All 28 specialized crons pass `neighborhoodId` per-article. `retry-missing-images` also detects and replaces existing `cron-cache/` AI images with Unsplash.

### Email System
- **Scheduler:** `src/lib/email/scheduler.ts`  7 AM local time per recipient
- **Assembler:** `src/lib/email/assembler.ts`  explicit `fetchBriefAsStory()` + `fetchLookAheadAsStory()` per section (primary + each satellite), 2 stories per neighborhood (1 Daily Brief + 1 Look Ahead, 48h lookback). `isGreetingOnly()` regex detects greeting-only preview text (multilingual), `extractSentences()` splits text at sentence boundaries while skipping single-letter initials (e.g., "Solomon R."), falls back to first 2 non-greeting sentences of `body_text`. Dateline in category labels.
- **Sender:** `src/lib/email/sender.ts`  React Email via Resend. Sender name always "Flaneur News" (extracts email from `EMAIL_FROM` env var, wraps with display name). Daily Brief subject: `{teaser}, {neighborhood}` all lowercase (under 70 chars, e.g., "toughest table, west village"). Prefers Gemini-generated teaser from `neighborhood_briefs.subject_teaser`, falls back to lead headline (word-boundary truncated). No "Daily Brief:" prefix. Fallback when no teaser: `your morning brief, {neighborhood}`. Preview text: "Your morning brief from {Neighborhood}+" (+ appended when satellite neighborhoods exist).
- **Sunday Edition subject:** `{teaser}, {neighborhood}` all lowercase (matches Daily Brief format). Gemini-generated teaser from `weekly_briefs.subject_teaser` preferred, falls back to lead headline truncated at word boundary, last resort `your sunday edition, {neighborhood}`. `buildSundaySubject()` defined in both cron and on-demand routes.
- **Sunday Edition:** `src/lib/weekly-brief-service.ts`  Gemini Pro-first/Flash-fallback + Grok. Cron checks Pro RPD usage at start, uses Pro until budget exhausted (~5 calls/neighborhood), then falls back to Flash. Model param threaded through all 7 Gemini calls. Sections: The Letter, The Next Few Days, That Time of Year, Data Point, Your Other Editions. Cron processes 5 neighborhoods concurrently (~10/run at 280s budget). Schedule: `0 * * * 6,0` (hourly Saturday + Sunday, 48h window for full 270 neighborhood coverage). `weekDate` always calculates "this coming Sunday" (if already Sunday, use today; otherwise add days until Sunday) so Saturday and Sunday runs share the same date for dedup. Enrichment uses `weeklyRecapStyle` which forces Sunday framing regardless of processing day. Banned generic opener "quiet significance" and variants.
- **Sunday Edition template:** `SundayEditionTemplate.tsx` renders all narrative paragraphs in The Letter (not just teaser), single "Read the full edition" CTA (no duplicate "Continue reading" link), Unsplash hero image, postcards AND "Your Other Editions" shown together (not either/or).
- **Sunday Edition sender:** `send-sunday-edition/route.ts` falls back to other subscribed neighborhoods when primary has no weekly brief (iterates through all subscribed IDs, uses first with a brief, logs fallback). All downstream references (article URLs, Look Ahead, ad resolution, send tracking, secondary neighborhoods) use `usedNeighborhoodId`. Hero image fetched via `selectLibraryImageAsync()`. **Per-recipient dedup:** `recipientsSentThisWeek` Set checks `recipient_id` (not `recipient_id:neighborhood_id`) so each person gets at most one Sunday Edition per week regardless of which neighborhood is selected by fallback. The per-neighborhood `sentSet` is kept for backward compat but the per-recipient check runs first.
- **Holiday system:** 50 holidays across 20 countries. Local holidays listed before global so `detectUpcomingHoliday()` prioritizes them (e.g., Lunar New Year over Valentine's Day for Singapore). `detectUpcomingHoliday` accepts optional `referenceDate` param (publication `weekDate`) to anchor the 7-day window to the edition date, not generation time - prevents past holidays from appearing when briefs are generated days before publication. Fixed-date and nth-weekday holidays use calculation; lunar/Islamic/Hebrew/Hindu holidays use lookup tables (2025-2030). Regions: East Asian (CNY, Mid-Autumn, Dragon Boat), Japanese (Golden Week, Obon, Coming of Age), Islamic (Eid al-Fitr, Eid al-Adha), Jewish (Passover, Rosh Hashanah, Yom Kippur, Hanukkah), Indian (Diwali, Vesak), European national days, South African, UAE National Day, plus existing Western holidays.
- **Data Point voice:** Prompts reference neighborhood by name ("The Tribeca median listing", "Crime in Nolita is holding steady") instead of "we/our" possessive voice. Never use "we/our/us" in data point context - sounds too possessive for real estate/safety data.
- **Weather:** Pure logic in `src/lib/email/weather-story.ts` (no LLM). Priority hierarchy: 1) Safety/Extremes (blizzard, extreme heat)  red-bordered WeatherStoryCard, 2) Travel & Lunch (weekday rain probability)  thin-bordered `tomorrowBox`, 3) Weekend Lookahead (Thu/Fri only), 4) General Anomaly (forecast vs climate normals). Non-alert stories (priority 2-4) render in thin-bordered box (`tomorrowBox` style, `backgroundColor: '#fafafa'`) in `DailyBriefTemplate.tsx` with 13px #999999 text (each sentence on own line). Weather body references the forecast day explicitly. All probability displays use "% prob" suffix.
- **Hero block:** `{neighborhood}  {city}` (12px tracked caps) + temperature (48px Playfair Display, clickable link to Google weather search) + weather description + weather story hint (non-alerts only, 13px grey) - merged as one centered visual thought, no label
- **Temperature:** Single-unit: F for USA, C for everyone else. Sunday Edition data point same logic.
- **US neighborhoods:** F only. Determined by `neighborhoods.country`
- **Instant resend:** `src/lib/email/instant-resend.ts` (3/day resend limit, skips Sundays via `getUTCDay() === 0` early return matching daily brief cron behavior)
- **Global daily email limit:** `src/lib/email/daily-email-limit.ts` - max 5 content emails per recipient per day (UTC), checked across `daily_brief_sends` + `weekly_brief_sends`. Wired into daily brief sender, instant resend, Sunday Edition cron, and on-demand Sunday Edition request. Transactional emails (password reset, ad confirmations) are exempt.
- **Layout:** Primary stories use compact `StoryList variant="primary"` (19px/16px), no hero image. Native ad after all primary stories (bordered frame, 1px solid #eeeeee, 4px radius).
- **Section headers:** Always `{neighborhood}  {city}` - no smart geography hiding. City in muted `#b0b0b0`.
- **Section dividers:** `SectionDivider` component - centered wide-tracked uppercase `{name}  {city}` + 32px gold accent rule (`rgba(120, 53, 15, 0.4)`). When combined text exceeds 25 chars, city renders on separate centered line below neighborhood name (prevents word-wrap on mobile for long names like "Greenwich Backcountry  New York Surroundings"). Same stacking logic in `DailyBriefTemplate.tsx` hero block.
- **Truncation:** `truncateAtSentence()` (160 chars) for both primary (`StoryList`) and satellite (`SatelliteSection`) preview text. No CSS line-clamp (was causing Gmail to render "..." dots instead of content).
- **Metadata word wrap:** `StoryList.tsx` drops city from location when combined `categoryLabel  location` exceeds 50 chars (shows just neighborhood name).
- **Preview text:** Uses plain hidden `<div>` instead of react-email `<Preview>` component. The `@react-email/preview` component injects 100+ invisible Unicode filler characters that Gmail renders as a visible "..." bubble. Both DailyBriefTemplate and SundayEditionTemplate use `previewHidden` style constant.
- **Typography:** Playfair Display via Google Fonts `@import` (Apple Mail renders; Gmail falls back to Georgia serif). All headlines, masthead, temperature use serif.
- **Masthead:** "FLANEUR" is a clickable link to `readflaneur.com` in both Daily Brief (`Header.tsx`) and Sunday Edition templates. Styled to match surrounding text (no underline).
- **Ad fallback:** `src/lib/email/ads.ts` - paid ads first, then random house ad from `house_ads` table. `app_download` type resolves dynamic discovery brief URL via `findDiscoveryBrief()`. NativeAd supports body text, centered layout, bordered frame (1px solid, 4px radius). Image wrapped in `{ad.imageUrl && (...)}` to prevent alt text rendering as blue link when no image exists. Sunday Edition sponsor ad has matching bordered frame (1px solid #e8e0d4).
- **Category labels:** `cleanCategoryLabel()` in assembler.ts strips neighborhood prefix, then renames "Daily Brief" to "Daily Brief (Today)" and "Look Ahead" to "Look Ahead (next 7 days)" for email display. Accepts optional `publishedAt` and `timezone` params  only shows "(Today)" when article is actually from today in recipient's timezone via `isSameDay(a, b, timezone)` check. `formatDateline(dateString?, timezone?)` formats dates in recipient timezone. Both threaded from `assembleDailyBrief()` via `recipient.timezone` through `fetchBriefAsStory`/`fetchLookAheadAsStory`/`toEmailStory`. Appended with dateline: "Daily Brief (Today) - Wed Feb 18".
- **Footer "forwarded" CTA:** "Was this forwarded to you? Subscribe here  it's free." shown in all emails. Daily Brief: rendered by `Footer.tsx`. Sunday Edition: inline in `SundayEditionTemplate.tsx`. Links to `/invite`.
- **Welcome email deliverability coaching:** `buildMagicLinkEmail()` in `subscribe/route.ts` includes platform-specific inbox tips after Verify Email button (Gmail Primary tab, Apple Mail VIPs, add to contacts).
- **Welcome email "Here's what to expect" grid:** 2x2 grid + bonus row between CTA and deliverability coaching showing Daily Brief, Look Ahead, Sunday Edition, Family Corner, Escape Mode features.
- **Inline referral CTA:** "Know someone who'd enjoy this? Share Flaneur or forward this email." After primary stories in `DailyBriefTemplate.tsx`, before footer in `SundayEditionTemplate.tsx`. Only renders when `referralUrl` exists.
- **Email divider hierarchy:** Primary story dividers `#d5d5d5`. Full-width `#999999` divider between primary and satellite sections (`DailyBriefTemplate.tsx`). Satellite section dividers full-width `#e0e0e0` (replaced 32px amber). Light `#e5e5e5` dividers between satellite stories.
- **Deduplication:** assembler.ts tracks seen article URLs in a Set - same story never appears in both primary and satellite sections
- **On-demand secondary editions:** `src/app/api/email/sunday-edition-request/route.ts` - two-step confirmation (prevents email client prefetch). Template shows "Your Other Editions" links for secondary neighborhoods. Dedup index: `(recipient_id, neighborhood_id, week_date)`. Rate limit: 5 on-demand sends per week. On-demand emails do NOT include secondary neighborhood buttons (no recursion).

### Ad System
- **Pricing:** `src/config/ad-tiers.ts`, `src/lib/PricingService.ts`  flat per-day rates (Tier 1: $500/$750, Tier 2: $200/$300, Tier 3: $100/$150)

- **Booking:** `/advertise` page with `react-day-picker` calendar  Stripe Checkout  asset upload  AI review
- **Placement toggle:** `CollectionsWithPlacement.tsx`  Daily Brief / Sunday Edition toggle between Collections header and pricing cards, highlights active pricing
- **Availability:** `GET /api/ads/availability`  booked/blocked dates + pricing per neighborhood/month
- **Checkout:** `POST /api/ads/checkout`  accepts `neighborhoodIds[]` array, creates N ads + N Stripe line items, 48h90d window
- **Upload:** `/advertise/upload/[adId]`  sponsor label, headline, body, image, click URL (one per neighborhood)
- **Success:** `/advertise/success`  post-payment confirmation with per-neighborhood upload links
- **Quality:** `src/lib/ad-quality-service.ts`  Gemini image analysis + copy polisher
- **Proof page:** `/proofs/[token]`  no auth, token-based
- **Approval flow:** `pending_payment`  `pending_assets`  `in_review`  `active` (via admin approval)
- **AI quality:** `pending_ai`  `pending_approval`  `approved` / `changes_requested`
- **Sunday ad resolver:** `src/lib/email/sunday-ad-resolver.ts`  date-aware cascade (`.lte('start_date', today).gte('end_date', today)` matching Daily Brief pattern in `ads.ts`) with house ad fallback
- **Date-aware delivery:** `src/lib/email/ads.ts` and `src/lib/ad-engine.ts` filter by `start_date <= today <= end_date`
- **Multi-neighborhood:** Calendar shows merged availability, pills UI for selection (with combo component names), combo component search (e.g. "FiDi" finds Tribeca)
- **Double-booking prevention:** unique composite index on `(neighborhood_id, placement_type, start_date)`
- **Stripe session:** `stripe_session_id` shared across N ads from same checkout (not unique)
- **Global takeover:** $10,000/day or $15,000/Sunday, contact-only (`ads@readflaneur.com`)
- **Storage:** `ad-assets` Supabase bucket for uploaded ad images

### Enhanced Neighborhood Search
- **Shared search:** `src/lib/search-aliases.ts`  country/region/state aliases + `resolveSearchQuery()` with priority scoring
- **Geo utils:** `src/lib/geo-utils.ts`  Haversine distance, `sortByDistance()`, `formatDistance()`
- **Advertise page:** `AdBookingCalendar.tsx`  searches by name/city/component/country/region/state, "Near me" geolocation, grouped city headers for broad queries, "Select all in city"
- **Header modal:** `NeighborhoodSelectorModal.tsx`  "City Search" dark glassmorphism UI (`bg-neutral-900/90 backdrop-blur-md`), CSS columns masonry layout, text-based items (not pills), amber accent system for selected/vacation/enclave, toggle select/deselect per city, "Change Primary" link in header (scrolls to + highlights primary), "Clear all" with two-tap confirmation in footer, slide-up + backdrop-fade animations. Mobile: `inset-x-0 top-2 bottom-0` (full-bleed bottom) with `pb-[max(1rem,env(safe-area-inset-bottom))]` on footer for iOS safe area. Settings section (city dropdown + detect + save) above footer. `handleExplore()` uses localStorage order (primary-first).
- **Settings in modal:** City/timezone settings merged into neighborhood modal (compact row above footer). Settings links removed from Header nav (desktop + mobile). `/settings` page still accessible via direct URL.
- **Accent-insensitive search:** NFD normalization strips diacritical marks  "ostermalm" matches "stermalm"
- **Alias suppression:** when query matches a country/region/state alias, loose substring matches are suppressed (prevents "US" matching "Justicia")
- **Sort by nearest:** "Sort by nearest to me" button below search input, geolocation-based sorting
- **Sort by region:** "Sort by region" button next to nearest  groups cities into geographic sections (North America, South America, Europe, Middle East, Asia & Pacific) with headers. Toggles to "Sort alphabetically" when active. Vacation/enclave regions mapped to geographic parent.
- **Timezone tooltip:** "Change my Timezone" button shows hover tooltip explaining it controls 7am email delivery time

### Article Search
- **Page:** `/search` (`src/app/search/page.tsx`) - full-page search with X close button (`router.back()`), rounded-lg inputs/buttons/cards
- **API:** `GET /api/search?q={query}` - searches articles by headline, body, preview text via Supabase `ilike`. Max 50 results.
- **Header icon:** Magnifying glass in both desktop nav and mobile icon bar, links to `/search`
- **Results:** Thumbnail + neighborhood (uppercase tracked) + time ago + headline. Excerpts hidden on mobile.

### Combo Neighborhoods
- `src/lib/combo-utils.ts`  `getNeighborhoodIdsForQuery()`, `getComboInfo()`, `getComboForComponent()`
- Articles stored under component IDs (e.g., `nyc-fidi`, `nyc-tribeca-core`), not the combo ID (`nyc-tribeca`)
- Query must include BOTH combo ID and component IDs  use `combo_neighborhoods` table to expand
- `/feed` page does early combo expansion via `combo_neighborhoods` table, passes `combo_component_ids` to client components. `MultiFeed` uses `in.(id1,id2,id3)` for REST queries when a combo pill is selected.
- Article detail page uses `getComboForComponent()` to show parent combo name as a breadcrumb link for component neighborhood articles
- Dedicated neighborhood pages (`/[city]/[neighborhood]/page.tsx`) already use `getNeighborhoodIdsForQuery()`  no fix needed

### Reactions System
- **Table:** `article_reactions` (bookmark, heart)  replaces comments. Fire emoji removed.
- **API:** `src/app/api/reactions/route.ts`  GET counts, POST toggle
- **Saved:** `src/app/api/reactions/saved/route.ts` + `/saved` page
- **Component:** `src/components/article/ArticleReactions.tsx`  compact inline (no borders), optimistic UI, anonymous via localStorage
- Anonymous ID stored in `flaneur-anonymous-id` localStorage key

### Sentry Monitoring
- **Project:** `flaneur-web` (org: `flaneur-vk`, project ID: `4510840235884544`)
- **SDK:** `@sentry/nextjs` v10  client via `src/instrumentation-client.ts`, server/edge via `sentry.{server,edge}.config.ts`
- **Tunnel:** `/monitoring` route (bypasses ad blockers)
- **Trace rate:** 20% on all configs, session replays off, error replays 100%
- **API token:** `SENTRY_AUTH_TOKEN` in `.env.local` (read-only scope  can query issues but cannot resolve them; needs `event:write` for mutations)

### AI Model Management
- **Central config:** `src/config/ai-models.ts` - all model IDs in one place
- **Automated checker:** `src/app/api/cron/check-ai-models/route.ts` - monthly cron (1st at 9 AM UTC)
  - Phase 1: Gemini `models.list` API - checks our models exist + finds newer versions
  - Phase 2: Grok web search (3 queries, one per provider) for releases/deprecations
  - Creates `model_update_available` issues in `cron_issues` for admin review
  - Cost: ~$0.015/month
- **Provider docs:** [Anthropic](https://docs.anthropic.com/en/docs/about-claude/models), [Gemini](https://ai.google.dev/gemini-api/docs/models), [xAI/Grok](https://docs.x.ai/developers/models)
- **Current models:** Claude Sonnet 4.5, Gemini 2.5 Flash (enrichment fallback/translation), Gemini 2.5 Pro (enrichment primary + Sunday Edition, 1K RPD budget), Grok 4.1 Fast. Image library now uses Unsplash API (no AI image generation).
- **Import pattern:** `import { AI_MODELS } from '@/config/ai-models'` then use `AI_MODELS.GEMINI_FLASH` etc.
- **Cron metadata:** DB `ai_model` fields use short names (`'gemini-2.5-flash'`, `'claude-sonnet-4-5'`) not full version IDs

## Critical Gotchas

### VERCEL_URL vs NEXT_PUBLIC_APP_URL
`VERCEL_URL` points to preview deployments, NOT production. Always use:
```typescript
const baseUrl = process.env.NEXT_PUBLIC_APP_URL?.replace(/\n$/, '').replace(/\/$/, '')
  || (process.env.VERCEL_URL ? `https://${process.env.VERCEL_URL}` : 'http://localhost:3000');
```

### Supabase Auth: getUser() vs getSession()
- `getUser()` = network call, can hang. `getSession()` = cookies, instant.
- **Always use `getSession()`** in middleware/pages/components
- Add timeout wrappers (3-5s `Promise.race`) for auth/DB calls in UI

### Supabase PromiseLike
No `.catch()` on query builder. Use `.then(null, errorHandler)` or `Promise.resolve(query).catch(...)`.

### Supabase Foreign Key Joins
`neighborhood:neighborhoods(id, name, city)` returns a single **object**, not an array. Don't use `[0]` on the result.

### Gemini Prompts
JSON examples override prose instructions. If prompt says "Don't use AQI" but example shows `"AQI 42"`, Gemini follows the example.

### overflow-x: hidden Breaks Sticky Positioning
CSS spec: setting `overflow-x: hidden` forces `overflow-y: auto` (can't mix `hidden` with `visible`). This creates a scrolling context that captures `position: sticky` elements, breaking their viewport-relative behavior. **Use `overflow-x: clip` instead**  clips without creating a scrolling context. Applied in `globals.css` on `<main>`.

### Gmail Strips Anchor Links
Never use `<a href="#section-id">` in email templates  Gmail strips anchor hrefs entirely. Use plain `<Text>` labels instead (e.g., "Family Corner below" instead of a jump link).

### No Em Dashes
Never use em dashes () in user-facing text. Use hyphens (-) instead. Em dashes look AI-generated.

### Theme System (Light/Dark)
- **Default:** Dark mode. Toggle via sun/moon icon in Header (desktop nav + mobile hamburger area)
- **localStorage key:** `flaneur-theme` (`'dark'` | `'light'`, absence = dark)
- **Flash prevention:** Inline `<script>` in `layout.tsx` sets `data-theme` attribute before first paint
- **CSS variables:** Semantic tokens in `globals.css` `:root` (dark) and `[data-theme="light"]` (light)
- **Hook:** `useTheme()` from `src/hooks/useTheme.ts` - `{ theme, setTheme, toggleTheme }`
- **Component:** `ThemeToggle` from `src/components/layout/ThemeToggle.tsx`
- **Semantic Tailwind classes:** `text-fg`, `text-fg-muted`, `text-fg-subtle`, `bg-canvas`, `bg-surface`, `bg-elevated`, `border-border`, `border-border-strong`, `hover:bg-hover`, `hover:text-fg`, `text-accent`, `text-accent-muted`
- **Accent color:** `--theme-accent` - `#fbbf24` (amber-400) in dark, `#b45309` (amber-700) in light. Use `text-accent` for selected/interactive states that need contrast in both themes. `text-accent-muted` for softer variant.
- **Light palette:** Stone shades (warm undertone) - canvas `#fafaf9`, surface `#ffffff`, fg `#1c1917`
- **Dark palette:** Canvas `#050505`, Surface `#121212`, fg `#e5e5e5`
- **Buttons:** `.btn-primary` = `bg-fg text-canvas` hover amber-600, `.btn-secondary` = `bg-transparent text-fg border-border-strong`, `.btn-ghost` = `text-fg-muted` hover text-fg
- **Header:** `.header-bg` class (CSS var `--theme-header-bg`) + `backdrop-blur`, `border-border`
- **Force-dark sections:** Homepage hero, discover hero, invite hero use `data-theme="dark"` to scope all children to dark CSS variables
- **Gradient fades:** Use `from-canvas` (tracks theme automatically)
- **Article prose:** Semantic text classes (`text-fg`, `text-fg-muted`) instead of `prose-invert`
- **DO NOT touch:** email templates in `src/lib/email/` (must stay light for mail clients)
- **DO NOT touch:** `src/components/home/` (hero components, excluded from theme sweep)

### Homepage Hero ("Cinematic Dark Mode")
- **Background:** `bg-black` base + `radial-gradient(ellipse at top, rgba(30,30,30,1), rgba(0,0,0,1) 70%)` overlay for tonal depth (CSS-only, no image asset)
- **FLANEUR:** `text-6xl md:text-7xl lg:text-8xl` Cormorant Garamond serif, `tracking-[0.3em]`. Plain `<h1>` (no link wrapper - the "Read Stories" button is the CTA).
- **Tagline:** `tracking-[0.5em] uppercase`, `text-sm md:text-base`, neutral-400
- **Animations:** Staggered `heroFadeIn` keyframes in `globals.css` - 1.5s ease-out with 0.3s delays between elements (logo, tagline, stats, rule, "Read Stories" button at delay-4/1.2s)
- **Padding:** `py-28 md:py-36 lg:py-48` for cinematic breathing room
- **No neighborhood chips:** Homepage shows only hero + stats + button. `HomeSignupEnhanced` (with neighborhood chips) removed from homepage, kept on `/discover`.

### NeighborhoodHeader (Feed Page)
- **Mode prop:** `mode: 'single' | 'all'` (default `'single'`). Controls masthead content and control deck layout.
- **Masthead (single):** Centered `text-center pt-8`. City label, serif neighborhood name, italic combo sub-line, `NeighborhoodLiveStatus` with `mb-8`.
- **Masthead (all):** Centered `text-center pt-2 md:pt-6` (tighter mobile). "My Neighborhoods" heading (clickable - opens NeighborhoodSelectorModal) + "{N} locations" subtitle when no pill active. When a pill is active: neighborhood name + city inline on same baseline (`flex items-baseline justify-center gap-2.5`), combo component names on subtitle line below, Maps/History links, LiveStatus. Subtitle conditionally rendered (not fixed-height invisible). **Desktop compact bento masthead:** When bento grid is shown (`isMultiple && !activeFilter`), full NeighborhoodHeader is hidden on ALL screens (`hidden` not `md:hidden`) and replaced by compact row with "My Neighborhoods  {N} locations" on left + "PRIMARY NEIGHBORHOOD {name} {weather/time}" on right (translated via `feed.primaryNeighborhood`). Uses `items-baseline` for cross-size text alignment. Always visible without flash (condition is `isMultiple` not bento-data-dependent). **Mobile wake-up indicator:** `md:hidden` section in MultiFeed shows serif primary neighborhood name + grey city on left with `NeighborhoodLiveStatus` on right, directly above Daily Brief card.
- **Maps/History links (all mode):** Small grey dotted-underline links (`text-xs text-neutral-500 decoration-dotted`) under neighborhood name. Only shown when a specific pill is active. Same URLs as single-mode MAP/HISTORY.
- **NeighborhoodLiveStatus:** `font-mono text-xs font-medium tracking-[0.2em] text-amber-600/80`. Clickable - Google weather. Accepts `initialWeather` prop for server-side pre-fetch (skips client fetch when provided).
- **Control Deck:** CSS Grid `grid-cols-[minmax(0,1fr)_auto_minmax(0,1fr)]` for overflow-safe centering. Left: `<ContextSwitcher>` (truncates long names), Center: GUIDE/MAP/HISTORY `hidden md:flex` on desktop, `...` overflow dropdown on mobile (`md:hidden`), Right: ViewToggle.
- **ContextSwitcher:** `src/components/feed/ContextSwitcher.tsx` - dropdown trigger (`{LABEL} `, truncated `max-w-[80px] md:max-w-[200px]`) + popover (`bg-surface border-border-strong w-64 z-30`). Sections: "All Neighborhoods" (layers icon), neighborhood list (dot + name + city + primary badge + "Set primary" on hover with `hover:text-accent`), "Customize List..." (opens modal), "The Front Door" (house icon, links to `/discover`), "Invite a Friend" (via ShareWidget, shown only to subscribers). Click-outside + Escape close.
- **useNeighborhoodPreferences:** `src/hooks/useNeighborhoodPreferences.ts` - reads localStorage IDs, fetches name/city from Supabase, cross-tab sync via `storage` event. Exposes `primaryId` and `setPrimary(id)` to reorder localStorage array.
- **Primary neighborhood:** First item in localStorage array. Indicated across ContextSwitcher (amber dot + "PRIMARY" label), MultiFeed pill bar, HomeSignupEnhanced chips (on `/discover`), and NeighborhoodSelectorModal. Users can change primary via "Set primary" actions.
- **Combo dropdowns:** `bg-surface border-white/[0.08]`, items `hover:text-white hover:bg-white/5`
- **ViewToggle:** Desktop: two buttons (compact + gallery) in pill bar row, active `text-white`, inactive `text-neutral-300`. Mobile: rendered separately just above feed content (`md:hidden flex justify-end`), not in dropdown row.
- **DailyBriefWidget:** Renders between Control Deck and FeedList (passed as `dailyBrief` ReactNode prop to `NeighborhoodFeed` or `MultiFeed`). Spacing: `mt-8 mb-12`. Section headings in brief cards use `text-neutral-200` (brighter than body `text-neutral-400`). Brief headline is single-line (`whitespace-nowrap overflow-hidden`).
- **MultiFeed integration:** `MultiFeed` now uses `<NeighborhoodHeader mode="all">` instead of standalone header. Accepts `dailyBrief` and `initialWeather` props. Passes `comboComponentNames` for combo subtitle. Pill filter switches the daily brief dynamically - fetches brief from `neighborhood_briefs` table client-side per neighborhood, with skeleton loading state.
- **MultiFeed render order:** Neighborhood nav renders BEFORE masthead for vertical stability. Desktop pills `md:sticky` with `top: var(--header-offset, 64px)` (syncs with header hide/show via CSS variable). Opaque `md:bg-canvas` background. Mobile dropdown is not sticky. Left/right gradient fade indicators on desktop pill scroll container.
- **Header-pills sync:** Header sets `--header-offset` CSS variable on `<html>` (64px when visible, 0px when hidden on scroll-down). Pills transition smoothly via `transition-[top] duration-300 ease-in-out`. Eliminates gap where articles bleed through when header hides.
- **Back-to-top button:** `fixed bottom-6 right-4 z-40` on all screen sizes (previously top-center on desktop, which overlapped sticky pills).
- **Drag-to-reorder pills:** Desktop only. Neighborhood pills are `draggable` with pointer events. On drop: reorders localStorage, syncs cookie, calls `router.refresh()`. First pill = primary. Visual: dragged pill `opacity-50`, drop target amber left border, `cursor-grab`/`cursor-grabbing`. Mobile users reorder via the neighborhood selector modal.
- **ContextSwitcher setPrimary navigation:** `handleSetPrimary` syncs cookie from localStorage then calls `router.refresh()`, so MultiFeed reflects new primary immediately.
- **Shared slug utils:** `getCitySlugFromId()` and `getNeighborhoodSlugFromId()` in `neighborhood-utils.ts` replace duplicate helpers in MultiFeed, ComboNeighborhoodCards, feed/page.
- **ComboNeighborhoodCards:** Still exists for GuidesClient.tsx but removed from feed header

### Exploration Engagement (Multi-Level Discovery)
- **Problem solved:** Users clicking a postcard or discovery card read one article and bounce. Four strategies deepen engagement beyond 1 level.
- **`?explore=true` URL param:** Appended by BentoCard links, postcard links, and exploration suggestions. Activates exploration-mode UI on article pages.
- **API:** `GET /api/explore/next?neighborhoodId=xxx&city=yyy&country=zzz&lat=N&lng=N&category=zzz` - returns 3 contextual suggestions: `sameCity` (different neighborhood, same city), `sameTheme` (same category, any city), `geoHop` (different country, nearest by Haversine). Each `Suggestion` includes `neighborhoodName`, `city`, `headline`, `teaser`, `url`, `imageUrl` (Unsplash URLs only, null for non-Unsplash). 5-min `s-maxage` cache. All suggestion URLs include `?explore=true`.
- **Visual "Read Next" card:** `ExplorationNextSuggestions` (`src/components/article/ExplorationNextSuggestions.tsx`) - replaces plain text links. `border-t border-border` divider above "Keep exploring" label for visual separation. Hero card (first suggestion with Unsplash image): full-width `aspect-[2/1] md:aspect-[5/2]` with `rounded-xl`, gradient overlay `from-black/80 via-black/20`, tracked-caps neighborhood/city, serif headline (1-2 lines), "Continue exploring" CTA in `text-sm text-white font-medium tracking-wider uppercase`. Secondary suggestions show 32px circular Unsplash thumbnails with flex layout (matching sticky bar aesthetic). Fallback: styled `bg-surface border-border` card when no image available. sessionStorage cache (`flaneur-explore-{neighborhoodId}`) prevents redundant API calls across components. `getVisitedIds()` reads sessionStorage cache keys to find previously visited neighborhoods and passes as `exclude` param to API, breaking suggestion ping-pong loops.
- **Sticky ExplorationBar:** `ExplorationBar` (`src/components/article/ExplorationBar.tsx`) - fixed bottom bar, only renders when `?explore=true`. Appears at 40% article scroll via IntersectionObserver on a marker div. `bg-surface/90 backdrop-blur-md border-t border-border`. Layout: circular 40px Unsplash thumbnail + neighborhood name + headline + trail count ("N visited") + "Next" link + dismiss X. Positioned `bottom-0 md:bottom-14` with `z-[55]` to sit above the `z-50` LocationPrompt toast on mobile. Outer fixed wrapper has `pointer-events-none`, inner `max-w-2xl` content div has `pointer-events-auto` - clicks pass through bar's background to elements below (e.g., location toast buttons). Hides on scroll-up, reappears on scroll-down. Dismiss persists to `flaneur-explore-bar-dismissed` sessionStorage. 500ms delay before checking cache/fetching so ExplorationNextSuggestions caches first. Own `getVisitedIds()` + `exclude` param prevents suggesting already-visited neighborhoods (fixes wrong suggestion on level 2+ pages).
- **Exploration session trail:** `useExplorationSession` hook (`src/hooks/useExplorationSession.ts`) - tracks visited neighborhoods in `flaneur-exploration-session` sessionStorage as `{ trail: Array<{name, city, url}>, startedAt }`. Auto-adds current page on mount. Deduplicates by name+city.
- **Back link with trail count:** `ExplorationBackLink` in `ExplorationWrapper.tsx` - when trail > 1, shows "EXPLORING (N NEIGHBORHOODS)" instead of "KEEP EXPLORING". Creates micro-reward / progress feeling.
- **Subscribe nudge:** `ExploreSubscribeNudge` (`src/components/article/ExploreSubscribeNudge.tsx`) - renders after SourceAttribution when `?explore=true` and neighborhood not in localStorage `flaneur-neighborhood-preferences`. Single line: "Enjoying {name}?" + amber "Add to my neighborhoods" link. On click: adds to localStorage, syncs cookie via `syncNeighborhoodCookie()`, fire-and-forget `POST /api/neighborhoods/add`, shows checkmark "Added". Returns null if already subscribed.
- **Client wrappers:** `ExplorationWrapper.tsx` (`src/components/article/ExplorationWrapper.tsx`) - `ExplorationBackLink` and `ExplorationBarWithSession` connect `useExplorationSession` state to the server-rendered article page. Re-exported `ExploreSubscribeNudge`.
- **Article page integration:** `[slug]/page.tsx` uses `ExplorationBackLink` (replaces `BackToFeedLink`), `ExploreSubscribeNudge` (after SourceAttribution), `ExplorationNextSuggestions` (after editorial content, before bottom ad), `ExplorationBarWithSession` (after inner wrapper, fixed positioning). Outer div has `relative` for IntersectionObserver marker. In explore mode, `ExplorationNextSuggestions` renders ABOVE `BriefDiscoveryFooter` so "Keep Exploring" (next neighborhood) is the primary CTA right after subscribe nudge, with "Keep Reading" (current neighborhood links) below. Non-explore mode keeps original order.
- **Ad-free explore flow:** When `isExploring` is true, `[slug]/page.tsx` hides: top house ad (was blocking content immediately after back link), bottom house ad (was interrupting hero card  footer flow), `PostReadEmailCapture` (redundant with `ExploreSubscribeNudge`), and `MoreStoriesButton` (misleading `/feed` link when sticky bar + hero card already provide navigation). Paid `StoryOpenAd` is also gated - explore sessions are ad-free to preserve "next episode" momentum.
- **sessionStorage keys:** `flaneur-explore-{neighborhoodId}` (cached API response), `flaneur-explore-bar-dismissed` ('true'), `flaneur-exploration-session` (trail JSON)

### Article Page Navigation
- **Back link:** ` ALL MY NEIGHBORHOOD STORIES` at top (or ` KEEP EXPLORING` / ` EXPLORING (N NEIGHBORHOODS)` when `?explore=true`), links to `/feed`. `ExplorationBackLink` wraps `BackToFeedLink` with trail state.
- **Bottom CTA:** `MORE STORIES` button, also links to `/feed`. Both in `TranslatedArticleNav.tsx`.
- **Feed cookie:** Feed reads neighborhood IDs from `flaneur-neighborhoods` SameSite=Strict cookie (synced from localStorage by inline script in `layout.tsx`). `MultiFeed` detects empty `neighborhoods` prop, reads localStorage, syncs cookie, and calls `router.refresh()`. `syncChecked` state gate suppresses the "Choose Neighborhoods" empty state CTA until localStorage has been checked - prevents 1-2 second flash of empty state on mobile when server renders with empty cookie but localStorage has neighborhoods.
- **Empty feed CTA:** When localStorage is also empty (new user from search), shows centered "Choose Neighborhoods" button that opens the selector modal instead of a dead-end empty state. Only appears after `syncChecked` confirms localStorage is genuinely empty.
- **No neighborhood-specific links:** Article pages are entry points from shared links too - `/feed` loads the user's own neighborhood set regardless of which neighborhood the article belongs to
- **Source verification:** `SourceAttribution` shows source attribution for single-source articles. Props: `headline`, `neighborhoodName`, `editorNotes`, `category` passed from article page. Uses same dotted-underline academic link styling. Editorial categories (`brief_summary`, `look_ahead`, `weekly_recap`) suppress "verify here" entirely since they're AI-generated editorial content, not single-source news.
- **Government source attribution:** When `editor_notes` contains `Source: Name - URL` format, SourceAttribution displays a direct link to the authoritative government database (e.g., "NYC 311 Open Data"). The "Single-source story - verify here" fallback is NOT shown when a valid government source exists (government data is authoritative). 5 crons inject government source URLs into editor_notes: sync-nuisance-watch (NYC 311), sync-filming-permits (NYC Film Permits), sync-alfresco-permits (NYC Open Restaurants), sync-retail-watch (NYC DOB Signage), sync-nimby-alerts (dynamic per community board + agenda URL).
- **Nuisance watch location resolution:** `anonymizeAddress()` in `nuisance-watch.ts` uses 3-layer fallback: `street_name` -> extract street from `incident_address` (regex strips leading house numbers) -> cross streets (`cross_street_1`/`cross_street_2`). ALL CAPS 311 data converted via `titleCase()`. "0 Block of..." (house numbers 1-99) shows just street name. `clusterComplaints()` skips complaints with no resolvable location. `RawComplaint` interface includes optional `crossStreets` field.
- **Nuisance watch neighborhood roundups:** When 2+ complaint hotspots exist for the same neighborhood on the same day, the cron generates a single consolidated roundup article instead of separate per-location articles (e.g., "Noise Watch: 5 hotspots, 102 complaints across Upper West Side"). `generateNuisanceRoundup()` in `nuisance-watch.ts` uses Gemini to write a blurb mentioning top locations. `processNuisanceWatch()` returns `clusters` alongside `stories` so the cron can group by neighborhood. Single-hotspot neighborhoods still get individual articles. Roundup slug pattern: `nuisance-roundup-{neighborhoodId}-{date}`.
- **Nuisance watch story quality:** Both `generateNuisanceStory()` and `generateNuisanceRoundup()` must use exact date ranges (e.g., "Monday, February 12 through Wednesday, February 19")  never vague "this week". Ban "spike"/"surge" language since there is no historical comparison data. Roundup stories use structured bullet-point format (opening sentence, bullet list of hotspots with counts, closing sentence). Individual stories require exact dates in the body.
- **Civic data cron filter tuning:** Filming permits: 7-day lookahead (was 48h), includes Documentary/Music Video/Theater categories (was TV/Film/Commercial/WEB only). Retail watch: 30-day lookback (was 7d), ~200 brands including DTC (Warby Parker, Glossier, Allbirds), restaurant groups (Major Food Group, Balthazar, Via Carota), and premium retail (Moncler, Arc'teryx, Lululemon). Alfresco permits: 30-day lookback (was 7d), includes pending applications (not just approved) with appropriate "has applied for" language in stories. `OutdoorDiningEvent` has `isPending` flag.
- **NYC Open Data column name fixes:** Film permits API (`tg4x-b46p`) uses camelCase column names without underscores (e.g., `startdatetime` not `start_date_time`, `parkingheld` not `parking_held`). Alfresco API (`pitm-atqc`) uses `time_of_submission` not `time_submitted`, `bulding_number` (NYC typo) not `building`, seating interest values are `'sidewalk'`/`'both'` not `'yes'`. **Alfresco dataset stale since Aug 2023**  no new data available. Retail watch switched from stale BIS dataset (`ipu4-2q9a`, last updated 2018) to DOB NOW (`rbx6-tga4`) with `work_type='Sign'`.
- **Retail watch brand pattern false positives:** The `ald\b` shortcut in Aim Leon Dore's regex matched any name ending in "ald" (Ronald, Gerald, Donald) in owner/applicant fields  every permit matched ALD. Removed `|ald\b`, tightened 12 other patterns (Vince, Theory, Apple, COS, Edition, Aman, Sandro, Creed, Rumble, RH, Barry's, Credo) to require brand-specific context words (e.g., `/\bapple\s*(store|retail|inc)\b/i`). Changed dedup from permit-ID-based to brand+address-based slug to prevent duplicate articles for same location.
- **AI writing persona architecture:** Three-tier model: (1) **Grok** = neutral fact-gatherer ("You are a local news/events researcher"), no writing-style constraints so it doesn't filter facts; (2) **Claude Sonnet** (6 cron prompts in route.ts files) = insider resident persona with writing-style rules (no em dashes, no slang, assume reader is local); (3) **Gemini Flash/Pro** (30+ lib files) = insider resident persona via shared `insiderPersona(location, role)` from `src/lib/ai-persona.ts`. Grok feeds raw facts to Gemini enrichment which applies the voice. The `insiderPersona()` utility prevents drift: "You are a well-travelled, successful 35-year-old who has lived in {location} for years..." with insider writing rules and banned outsider phrases ("for those in the know", "the elite", "Manhattan's elite", "if you know you know", "the usual suspects", "movers and shakers"). Never define separate persona constants in cron files - 6 crons had stale `SYSTEM_PROMPT` constants that lacked the banned phrases.
- **Grok-powered event crons (9 crons):** Shared `grokEventSearch()` utility in `grok.ts` (Responses API with `web_search` + `x_search`, temperature 0.5). Each cron's system prompt requests JSON array, caller parses with `raw.match(/\[[\s\S]*\]/)` then validates against existing configs (brand whitelists, venue lists, airline configs, Blue Chip keywords). **Batching constraint:** Each `grokEventSearch()` call takes 60-120s. Must batch all items into 1-2 calls per cron (not per-item) to stay under 300s Vercel timeout  prompt lists all items with a discriminating field (e.g., `"venue"`, `"city"`, `"house"`) in the JSON response for mapping back. For large item counts, split into 2 regional batches (Americas + Europe/Asia) via `Promise.all`. Crons: overture-alert (9 venues, 1 call), museum-watch (18 museums, 2 calls), sample-sale (5 cities, 1 call), gala-watch (9 hubs, 1 call), route-alert (8 hubs, 1 call), residency-radar (1 call), archive-hunter (~15 stores, 1 call), nyc-auctions (3 houses, 1 call), global-auctions (5 hubs  3 houses, 2 calls). All preserve existing Gemini story generation + article insertion untouched.
- **political-wallet thresholds:** FEC API works but original thresholds were too restrictive. `LOOKBACK_DAYS` 730, `STORY_TRIGGER_THRESHOLD` $10K$2.5K, `POWER_DONOR_THRESHOLD` $1K$500.
- **heritage-filings fixes:** NYC DOB heritage filings had 24h lookback (too short for lagging dataset)  changed to 336h (14 days). Missing `nyc-` prefix on neighborhood IDs (same systemic bug as liquor-watch).
- **Liquor license cron rewrite:** Old cron used NY State dataset `wg8y-fzsj` requiring authentication (always 0 results). Switched to two public datasets: pending licenses (`f8i8-k2gm`) for new applications and active licenses (`9s3h-dpkz`) for recently granted. Full pipeline: fetch  filter newsworthy (restaurants, bars, hotels, clubs  skip grocery/manufacturer/wholesaler)  generate "Last Call" stories via Gemini Flash  create articles with brand+address dedup. Category labels: "Last Call: Application" / "Last Call: Approved". `NEIGHBORHOOD_ID_TO_CONFIG` keys lack `nyc-` prefix so `getNeighborhoodFromZip()` prepends it. Story generation parallelized in batches of 5. Uses placeholder image (not AI-generated) to stay within 120s function timeout.
- **Non-government single-source:** Text reads "This is a single-source story. It's always wise to double-check here" with "here" linking to Google Search (`headline + neighborhoodName`).

### Article Body Typography ("Effortless Legibility")
- **Font:** Merriweather (Google Fonts, screen-optimized serif) via `--font-body-serif` CSS variable, fallback Georgia/Times New Roman. ALL article content uses serif - no sans-serif overrides in EventListingBlock or elsewhere.
- **Size:** Mobile `text-[1.1rem]` (~17.6px), Desktop `text-[1.2rem]` (~19.2px) - consistent with feed card text (~17px) without jarring size jump
- **Line height:** `leading-relaxed` (1.625x) - comfortable on dark backgrounds without excessive spacing
- **Color:** `text-neutral-200` (off-white, never pure #FFFFFF on dark)
- **Paragraph spacing:** `mb-6` between paragraphs
- **Links:** Academic "invisible link" style - `text-current font-semibold underline decoration-dotted decoration-neutral-500/40 decoration-1 underline-offset-4`, hover: `decoration-solid decoration-neutral-300/60`. Markdown links `[text](url)` in content are rendered as clickable `<a>` tags. HTML `<a>` tags from AI output are converted to markdown format first. **Auto-linking disabled** - render-time entity detection and pipeline hyperlink injection both removed to avoid cluttered articles. No amber/blue link colors anywhere.
- **Bold:** `font-bold text-neutral-100`
- **Section headers:** `text-lg font-semibold text-fg mt-8 mb-4` in Merriweather

### Font Sizes (General)
- Feed body: 17px, Feed headlines: 20-22px (single-line on desktop `whitespace-nowrap overflow-hidden`, 2-line wrap on mobile gallery `line-clamp-2`), Metadata: 10-12px, Masthead: 30px
- Article body: 17.6-19.2px Merriweather serif
- **Date metadata format:** "Mon Feb 17" (weekday + month + day). Auto-translated via `Intl.DateTimeFormat(locale)`. Locale passed from `useLanguageContext()` in CompactArticleCard, ArticleCard, NeighborhoodBrief. Shared `formatDate()`/`formatRelativeTime()`/`getDayAbbr()` in `src/lib/utils.ts` accept `locale` and optional `timezone` params. Article detail page passes `article.neighborhood?.timezone` to `getDayAbbr()` so "Fri Daily Brief" displays correctly in neighborhood's local timezone.

## Project Structure

```
src/
 app/
    [city]/[neighborhood]/     # Feed, articles, guides
    discover/                   # Homepage without auto-redirect
    invite/                    # Referral invite landing page
    admin/                     # Cron monitor, ads, news-coverage, images
    saved/                     # Saved/bookmarked stories page
    settings/                  # User location preferences
    email/preferences/         # Email topic management
    advertise/                 # Booking calendar, success, upload pages
    proofs/[token]/            # Customer ad proof page
    api/
        cron/                  # 30+ automated cron jobs
        admin/                 # Admin APIs (cleanup-duplicates, suggestions, community-neighborhoods)
        ads/                   # Availability, checkout, upload, booking-info
        reactions/             # Emoji reactions API + saved articles
        email/                 # Unsubscribe, preferences, sunday-edition-request
        location/              # IP detect-and-match (nearest neighborhoods)
        referral/              # Referral code, track, convert, stats
        neighborhoods/         # Add, create, count community neighborhoods
        suggestions/           # Neighborhood suggestion submissions
        discover-neighborhood/ # Resolve nearby unsubscribed brief URL
        translations/           # Serve cached article/brief translations
        internal/              # Image generation, resend
        webhooks/              # Resend inbound
 config/
    ad-tiers.ts                # Flat per-day rates, tiers & seasonal rules
    ad-config.ts               # Ad collections (3 tiers)
    global-locations.ts        # City configs, vocabulary, zones
    nyc-locations.ts           # NYC zip/precinct mappings
 lib/
     adapters/                  # 13 city adapters (permits, liquor, safety)
     cron-monitor/              # Self-healing system
     email/                     # Scheduler, assembler, sender, templates
     location/                  # IP detection, timezone resolution
     community-pipeline.ts       # Community neighborhood creation utilities
     discover-neighborhood.ts    # Find nearby unsubscribed neighborhood briefs
     combo-utils.ts             # Combo neighborhood queries
     look-ahead-events.ts       # Structured event listing formatter (StructuredEvent, formatEventListing, isEventLine, isPlaceholder)
     rss-sources.ts             # RSS feed aggregation (DB + hardcoded fallback)
     search-aliases.ts          # Country/region/state search aliases
     geo-utils.ts               # Haversine distance + sorting
     grok.ts                    # Grok X Search integration
     brief-enricher-gemini.ts   # Gemini enrichment pipeline
     weekly-brief-service.ts    # Sunday Edition generation
     ad-quality-service.ts      # AI ad review pipeline
     translations.ts            # UI string dictionaries (9 languages)
     translation-service.ts     # Gemini Flash translation + DB lookup
     weather.ts                 # Server-side Open-Meteo weather fetch (10-min cache)
```

## Environment Variables

**Required:** `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY`, `ANTHROPIC_API_KEY`, `GOOGLE_PLACES_API_KEY`, `CRON_SECRET`
**Optional:** `GEMINI_API_KEY`, `GROK_API_KEY`, `OPENAI_API_KEY`, `UNSPLASH_ACCESS_KEY`, `RESEND_WEBHOOK_SECRET`, `STRIPE_WEBHOOK_SECRET`, `SENTRY_AUTH_TOKEN`

## Key Database Tables

- `neighborhoods`  270+ active neighborhoods with coordinates, region, country, `is_combo`, `is_community`, `created_by`, `community_status`
- `combo_neighborhoods`  join table for combo components
- `articles`  news articles with AI images (`enriched_at`, `enrichment_model`)
- `neighborhood_briefs`  Grok-generated daily summaries (column is `model`, NOT `ai_model`). `brief_date DATE NOT NULL` with `UNIQUE(neighborhood_id, brief_date)` constraint prevents duplicate briefs per neighborhood per day at DB level.
- `weekly_briefs`  Sunday Edition content (rearview, horizon, holiday, data_point)
- `ads`  ad campaigns with booking fields (stripe_session_id, customer_email, is_global_takeover) and quality control (proof_token, approval_status, ai_quality_score)
- `house_ads`  fallback ads (types: waitlist, app_download, advertise, newsletter, sunday_edition, suggest_neighborhood, community_neighborhood)
- `neighborhood_suggestions`  reader-submitted neighborhood requests (suggestion, email, city/country, status: new/reviewed/added/dismissed)
- `article_reactions`  emoji reactions (bookmark/heart/fire), anonymous + authenticated
- `cron_executions` / `cron_issues`  monitoring & self-healing
- `daily_brief_sends` / `weekly_brief_sends`  email dedup (weekly: unique on `recipient_id, neighborhood_id, week_date`)
- `referrals`  click/conversion tracking (referral_code, referrer_type/id, referred_email, status, ip_hash)
- `profiles`  user prefs (primary_city, primary_timezone, paused_topics, referral_code)
- `newsletter_subscribers`  timezone, paused_topics, referral_code
- `article_translations` / `brief_translations`  cached Gemini Flash translations (unique on article_id/brief_id + language_code)
- `rss_sources`  RSS feed URLs by city (192 feeds across 92 cities, 100% coverage)
- `neighborhood_reports`  user reports on community neighborhoods (unique per neighborhood+reporter, RLS: own reports only)
- `executive_applications`  executive status credit applications (status: pending, RLS: own applications only)

## Deployment

```bash
git push origin master    # Deploy (then promote in Vercel dashboard)
npx supabase db push --include-all --yes  # Run migrations
```

## MCP Servers

Supabase, Vercel, Playwright, Supermemory, Frontend Design, Resend, Stripe, Sentry
